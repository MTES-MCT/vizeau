import { BaseSeeder } from '@adonisjs/lucid/seeders'
import { ExploitationFactory } from '#database/factories/exploitation_factory'
import User from '#models/user'
import { DateTime } from 'luxon'

/*
 * Generate an array of DateTime objects representing the past `n` minutes from the `base` time.
 */
function pastMinutes(n: number, base = DateTime.local()): DateTime[] {
  const count = Math.max(0, Math.floor(n))
  const result: DateTime[] = []
  for (let i = 1; i <= count; i++) {
    result.push(base.minus({ minutes: i }))
  }
  return result
}

const logEntryCount = 15

export default class extends BaseSeeder {
  static environment = ['development']

  async run() {
    const user = await User.findByOrFail({ email: process.env.ADMIN_EMAIL })
    await ExploitationFactory.with('contacts', 1)
      .with('logEntries', logEntryCount, (logEntries) => {
        logEntries.merge(
          /*
           * Assign each log entry a createdAt and updatedAt timestamp which are spaced one minute apart in the past.
           * This simulates realistic log entry creation times.
           * Else, all log entries would have the exact same timestamp which breaks the exploitation page sort.
           */
          pastMinutes(logEntryCount).map((datetime) => ({
            userId: user.id,
            createdAt: datetime,
            updatedAt: datetime,
          }))
        )
      })
      .merge([
        {
          name: 'Vizeau DÃ©mo',
          location: { x: 6.184166666666667, y: 49.1580556 },
          commune: 'Metz',
          postalCode: '57000',
          // Set updatedAt to ensure it appears at the top of the list
          updatedAt: DateTime.local().plus({ minutes: 1 }),
        },
      ])
      .createMany(25)
  }
}
