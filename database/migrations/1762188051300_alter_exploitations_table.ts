import { BaseSchema } from '@adonisjs/lucid/schema'
import Exploitation from '#models/exploitation'

export default class extends BaseSchema {
  protected tableName = Exploitation.table

  async up() {
    this.schema.alterTable(this.tableName, (table) => {
      // We don't need this format (5 chars)
      table.dropColumn('commune_insee')

      // Most of the fields should be nullable to allow partial data entry
      table.setNullable('type_structure')
      table.setNullable('address')
      table.setNullable('postal_code')

      // Split address into multiple fields
      table.renameColumn('address', 'address_line_1')

      table.string('address_line_2').nullable()
      table.string('postal_box').nullable()
      table.string('commune').nullable()
      table.point('location').nullable()
    })
  }

  async down() {
    this.schema.alterTable(this.tableName, (table) => {
      table.renameColumn('address_line_1', 'address')
      table.dropColumn('address_line_2')
      table.dropColumn('postal_box')
      table.dropColumn('commune')
      table.dropColumn('location')

      table.dropNullable('type_structure')
      table.dropNullable('address')
      table.dropNullable('postal_code')

      table.string('commune_insee', 5)
    })
  }
}
