import type { HttpContext } from '@adonisjs/core/http'
import { createExploitationValidator } from '#validators/create_exploitation'
import { ExploitationService } from '#services/exploitation_service'
import { inject } from '@adonisjs/core'

@inject()
export default class ExploitationsController {
  constructor(public exploitationService: ExploitationService) {}

  async index({ inertia }: HttpContext) {
    return inertia.render('exploitations')
  }

  async store({ request, session, response }: HttpContext) {
    const { contactName, contactEmail, contactPhoneNumber, ...payload } =
      await request.validateUsing(createExploitationValidator)

    await this.exploitationService.createExploitationWithContact(payload, {
      name: contactName,
      email: contactEmail,
      phoneNumber: contactPhoneNumber,
    })

    session.flash('success', `L'exploitation ${payload.name} a été créée.`)

    return response.redirect('/exploitations')
  }
}
