import type { HttpContext } from '@adonisjs/core/http'
import {
  createExploitationValidator,
  updateExploitationValidator,
} from '#validators/create_exploitation'
import { ExploitationService } from '#services/exploitation_service'
import { inject } from '@adonisjs/core'

@inject()
export default class ExploitationsController {
  constructor(public exploitationService: ExploitationService) {}

  async index({ inertia }: HttpContext) {
    // Example of how you would use the service to get exploitations
    const exploitations = await this.exploitationService
      .queryActiveExploitations()
      .orderBy('updatedAt', 'desc')
      .paginate(1)

    return inertia.render('exploitations', { exploitations })
  }

  async store({ request, session, response }: HttpContext) {
    const { contactName, contactEmail, contactPhoneNumber, latitude, longitude, ...payload } =
      await request.validateUsing(createExploitationValidator)

    const location =
      latitude !== undefined && longitude !== undefined ? `(${longitude},${latitude})` : undefined

    // (latitude !== undefined && longitude !== undefined ? { location: \POINT(${longitude},${latitude})` } : {})
    await this.exploitationService.createExploitationWithContact(
      { ...payload, location },
      {
        name: contactName,
        email: contactEmail,
        phoneNumber: contactPhoneNumber,
      }
    )

    session.flash('success', `L'exploitation ${payload.name} a été créée.`)

    return response.redirect().toRoute('exploitations.index')
  }

  async edit({ request, session, response }: HttpContext) {
    const {
      contactName,
      contactEmail,
      contactPhoneNumber,
      latitude,
      longitude,
      params,
      ...payload
    } = await request.validateUsing(updateExploitationValidator)

    const location =
      latitude !== undefined && longitude !== undefined ? `(${longitude},${latitude})` : undefined

    await this.exploitationService.updateExploitationWithContact(
      params.id,
      { ...payload, location },
      {
        name: contactName,
        email: contactEmail,
        phoneNumber: contactPhoneNumber,
      }
    )

    session.flash('success', `L'exploitation ${payload.name} a été modifiée.`)

    return response.redirect().toRoute('exploitations.index')
  }

  async destroy({ params, session, response }: HttpContext) {
    await this.exploitationService.deleteExploitation(params.id)

    session.flash('success', `L'exploitation a été supprimée.`)

    return response.redirect().toRoute('exploitations.index')
  }
}
