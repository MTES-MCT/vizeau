import Exploitation from '#models/exploitation'
import { ExploitationJson, PaginatedJson } from '../../types/models.js'
import { ModelPaginatorContract } from '@adonisjs/lucid/types/model'
import { LogEntryDto } from './log_entry_dto.js'
import { ParcelleDto } from './parcelle_dto.js'
import Env from '#start/env'

export class ExploitationDto {
  static fromModel(exploitation: Exploitation): ExploitationJson {
    if (!exploitation.user) {
      console.warn('Exploitation model is missing user relation, isDemo may be incorrectly false')
    }

    return {
      id: exploitation.id,
      name: exploitation.name,
      formeJuridique: exploitation.formeJuridique,
      siret: exploitation.siret,
      denominationLegale: exploitation.denominationLegale,
      activite: exploitation.activite,
      addressLine1: exploitation.addressLine1,
      addressLine2: exploitation.addressLine2,
      commune: exploitation.commune,
      postalCode: exploitation.postalCode,
      postalBox: exploitation.postalBox,
      notes: exploitation.notes,
      location: exploitation.location,
      contacts: exploitation.contacts,
      tags: exploitation.tags,
      logEntries: exploitation.logEntries?.map((logEntry) => LogEntryDto.fromModel(logEntry)),
      parcelles: exploitation.parcelles?.map((parcelle) => ParcelleDto.fromModel(parcelle)),
      isDemo: exploitation.user?.email === Env.get('ADMIN_EMAIL'),
    }
  }

  static fromPaginator(
    paginatedExploitations: ModelPaginatorContract<Exploitation>
  ): PaginatedJson<ExploitationJson> {
    const transformedData = (paginatedExploitations.toJSON().data as Exploitation[]).map(
      ExploitationDto.fromModel
    )

    return {
      meta: paginatedExploitations.getMeta(),
      data: transformedData,
    }
  }

  static toJsonArray(exploitations: Exploitation[]): ExploitationJson[] {
    return exploitations.map(ExploitationDto.fromModel)
  }
}
