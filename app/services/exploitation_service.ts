import Exploitation from '#models/exploitation'
import Contact from '#models/contact'
import { ModelAttributes } from '@adonisjs/lucid/types/model'

export class ExploitationService {
  /**
   * Create an exploitation with an optional contact.
   * If contactData is provided and contains a name, a contact will be created and associated with the exploitation.
   */
  async createExploitationWithContact(
    exploitationData: Partial<ModelAttributes<Exploitation>>,
    contactData?: Partial<ModelAttributes<Contact>>
  ) {
    const exploitation = await Exploitation.create(exploitationData)

    if (contactData?.name) {
      await exploitation.related('contacts').create(contactData)
    }

    return exploitation
  }

  async updateExploitationWithContact(
    exploitationId: string,
    exploitationData: Partial<ModelAttributes<Exploitation>>,
    contactData?: Partial<ModelAttributes<Contact>>
  ) {
    const exploitation = await Exploitation.findOrFail(exploitationId)

    exploitation.merge(exploitationData)
    await exploitation.save()

    if (contactData?.name) {
      const contacts = await exploitation.related('contacts').query()

      if (contacts.length > 0) {
        // We can only have 0 or 1 contact per exploitation for the MVP
        contacts[0].merge(contactData)
        await contacts[0].save()
      } else {
        await exploitation.related('contacts').create(contactData)
      }
    }

    return exploitation
  }
}
