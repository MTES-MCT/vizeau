import vine from '@vinejs/vine'
import Exploitation from '#models/exploitation'

const exploitationFormFieldsValidator = {
  name: vine.string().maxLength(255),
  formeJuridique: vine.string().optional().nullable(),
  siret: vine
    .string()
    .maxLength(14)
    .unique(async (db, value, field) => {
      // Siret must be unique among non-deleted exploitations
      const query = db.from(Exploitation.table).where('siret', value).andWhere('is_deleted', false)

      // If we're updating an existing exploitation, exclude it from the uniqueness check
      if (field.data?.id) {
        query.andWhereNot('id', field.data.id)
      }

      const result = await query.first()

      return result === null
    })
    .optional()
    .nullable(),
  denominationLegale: vine.string().maxLength(255).optional().nullable(),
  activite: vine.string().maxLength(255).optional().nullable(),
  addressLine1: vine.string().maxLength(255).optional().nullable(),
  addressLine2: vine.string().maxLength(255).optional().nullable(),
  postalCode: vine.string().maxLength(10).optional().nullable(),
  postalBox: vine.string().maxLength(255).optional().nullable(),
  commune: vine.string().maxLength(255).optional().nullable(),
  notes: vine.string().maxLength(4000).optional().nullable(),
  latitude: vine.number().min(-90).max(90).optional().nullable(),
  longitude: vine.number().min(-180).max(180).optional().nullable(),
  contactFirstName: vine.string().maxLength(255).optional().nullable(),
  contactLastName: vine.string().maxLength(255).optional().nullable(),
  contactRole: vine.string().maxLength(255).optional().nullable(),
  contactPhoneNumber: vine.string().minLength(7).maxLength(20).optional().nullable(),
  contactEmail: vine.string().email().optional().nullable(),
}

export const createExploitationValidator = vine.compile(
  vine.object(exploitationFormFieldsValidator)
)

// Same but with params for the exploitation ID
export const updateExploitationValidator = vine.compile(
  vine.object({
    ...exploitationFormFieldsValidator,
    params: vine.object({ id: vine.string().uuid() }),
  })
)
