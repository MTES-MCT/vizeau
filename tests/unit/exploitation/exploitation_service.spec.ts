import { test } from '@japa/runner'
import testUtils from '@adonisjs/core/services/test_utils'
import { ExploitationService } from '#services/exploitation_service'
import { ExploitationFactory } from '#database/factories/exploitation_factory'

test.group('Exploitation service', (group) => {
  group.each.setup(() => testUtils.db().withGlobalTransaction())

  test('I can create an exploitation with a contact', async ({ assert }) => {
    const exploitationPayload = await ExploitationFactory.make()
    const exploitationService = new ExploitationService()

    const persistedExploitation = await exploitationService.createExploitationWithContact(
      exploitationPayload,
      {
        name: 'John Doe',
        email: 'john.doe@ld.co',
        phoneNumber: '1234567890',
      }
    )

    await persistedExploitation.load('contacts')

    assert.exists(persistedExploitation.id)
    assert.lengthOf(persistedExploitation.contacts, 1)
    assert.equal(persistedExploitation.contacts[0].name, 'John Doe')
  })

  test('I can create an exploitation without a contact', async ({ assert }) => {
    const exploitationPayload = await ExploitationFactory.make()
    const exploitationService = new ExploitationService()

    const persistedExploitation =
      await exploitationService.createExploitationWithContact(exploitationPayload)

    await persistedExploitation.load('contacts')

    assert.exists(persistedExploitation.id)
    assert.lengthOf(persistedExploitation.contacts, 0)
  })

  test("I can't create an exploitation without a name", async ({ assert }) => {
    const exploitationPayload = await ExploitationFactory.make()
    exploitationPayload.name = undefined as any
    const exploitationService = new ExploitationService()

    assert.rejects(() =>
      exploitationService.createExploitationWithContact(exploitationPayload, {
        name: 'John Doe',
        email: 'john.doe@ld.co',
        phoneNumber: '1234567890',
      })
    )
  })

  test('I can update an exploitation', async ({ assert }) => {
    const exploitation = await ExploitationFactory.create()
    const exploitationService = new ExploitationService()

    const newName = 'Updated Exploitation Name'

    const updatedExploitation = await exploitationService.updateExploitationWithContact(
      exploitation.id,
      { name: newName }
    )

    assert.equal(updatedExploitation.name, newName)
  })

  test('I can update an exploitation and its contact', async ({ assert }) => {
    const exploitation = await ExploitationFactory.with('contacts', 1).create()
    const exploitationService = new ExploitationService()

    const newName = 'Updated Exploitation Name'
    const newContactName = 'Jane Doe'

    const updatedExploitation = await exploitationService.updateExploitationWithContact(
      exploitation.id,
      { name: newName },
      { name: newContactName }
    )

    assert.equal(updatedExploitation.name, newName)
    await updatedExploitation.load('contacts')
    assert.equal(updatedExploitation.contacts[0].name, newContactName)
  })

  test("I can create a contact when updating an exploitation that didn't have one", async ({
    assert,
  }) => {
    const exploitation = await ExploitationFactory.create()
    const exploitationService = new ExploitationService()

    const newContactName = 'Jane Doe'
    const updatedExploitation = await exploitationService.updateExploitationWithContact(
      exploitation.id,
      {},
      { name: newContactName }
    )
    await updatedExploitation.load('contacts')

    assert.lengthOf(updatedExploitation.contacts, 1)
    assert.equal(updatedExploitation.contacts[0].name, newContactName)
  })

  test("I can't update a non-existing exploitation", async ({ assert }) => {
    const exploitationService = new ExploitationService()

    assert.rejects(() =>
      exploitationService.updateExploitationWithContact('non-existing-id', { name: 'Name' })
    )
  })
})
