import { test } from '@japa/runner'
import testUtils from '@adonisjs/core/services/test_utils'
import { ExploitationFactory } from '#database/factories/exploitation_factory'
import { ExploitationTagFactory } from '#database/factories/exploitation_tag_factory'

test.group('Exploitation CRUD', (group) => {
  group.each.setup(() => testUtils.db().withGlobalTransaction())

  test('I can create an exploitation', async ({ assert }) => {
    const exploitation = await ExploitationFactory.create()
    assert.isNotNull(exploitation)
  })

  test('I can create a tag', async ({ assert }) => {
    const tag = await ExploitationTagFactory.with('owner', 1).create()
    assert.isNotNull(tag)
  })

  test('I can add a tag to an exploitation', async ({ assert }) => {
    const exploitation = await ExploitationFactory.create()
    const tag = await ExploitationTagFactory.with('owner', 1).create()

    await exploitation.related('tags').attach([tag.id])
    await exploitation.load('tags')
    assert.isNotEmpty(exploitation.tags)
  })

  test("I can fetch an exploitation's contacts", async ({ assert }) => {
    const exploitation = await ExploitationFactory.with('contacts', 3).create()
    await exploitation.load('contacts')

    assert.lengthOf(exploitation.contacts, 3)
  })
})
