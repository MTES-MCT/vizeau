import { test } from '@japa/runner'
import testUtils from '@adonisjs/core/services/test_utils'
import { ExploitationFactory } from '#database/factories/exploitation_factory'
import { UserFactory } from '#database/factories/user_factory'
import { ExploitationTagService } from '#services/exploitation_tag_service'

test.group('Exploitation tag service', (group) => {
  group.each.setup(() => testUtils.db().withGlobalTransaction())

  test('I can create an exploitation tag', async ({ assert }) => {
    const user = await UserFactory.create()
    const exploitation = await ExploitationFactory.create()
    const exploitationTagService = new ExploitationTagService()

    const tag = await exploitationTagService.createTagForExploitation(
      exploitation.id,
      user.id,
      'Urgent'
    )

    assert.exists(tag.id)
  })

  test('I can fetch exploitation tags', async ({ assert }) => {
    const user = await UserFactory.create()
    const exploitation = await ExploitationFactory.create()
    const exploitationTagService = new ExploitationTagService()

    await exploitationTagService.createTagForExploitation(exploitation.id, user.id, 'Urgent')
    await exploitationTagService.createTagForExploitation(exploitation.id, user.id, 'Follow-up')

    const tags = await exploitationTagService.getTagsForExploitation(exploitation.id)

    assert.lengthOf(tags, 2)
  })

  test('I can update an exploitation tag', async ({ assert }) => {
    const user = await UserFactory.create()
    const exploitation = await ExploitationFactory.create()
    const exploitationTagService = new ExploitationTagService()

    const tag = await exploitationTagService.createTagForExploitation(
      exploitation.id,
      user.id,
      'Urgent'
    )

    const updatedTag = await exploitationTagService.updateTag(tag.id, 'High Priority')

    assert.equal(updatedTag.name, 'High Priority')
  })

  test('I can delete an exploitation tag', async ({ assert }) => {
    const user = await UserFactory.create()
    const exploitation = await ExploitationFactory.create()
    const exploitationTagService = new ExploitationTagService()

    const tag = await exploitationTagService.createTagForExploitation(
      exploitation.id,
      user.id,
      'Urgent'
    )

    await exploitationTagService.deleteTag(tag.id)

    const tags = await exploitationTagService.getTagsForExploitation(exploitation.id)

    assert.lengthOf(tags, 0)
  })
})
