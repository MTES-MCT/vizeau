import testUtils from '@adonisjs/core/services/test_utils'
import { test } from '@japa/runner'
import { UserFactory } from '#database/factories/user_factory'
import { ExploitationFactory } from '#database/factories/exploitation_factory'
import Exploitation from '#models/exploitation'

test.group('Exploitation - Destroy Resource', (group) => {
  group.each.setup(() => testUtils.db().withGlobalTransaction())

  test('I can destroy an existing Exploitation', async ({ assert, client, route }) => {
    const user = await UserFactory.create()
    const existingExploitation = await ExploitationFactory.create()

    const response = await client
      .delete(route('exploitations.destroy', { id: existingExploitation.id }))
      .loginAs(user)
      .withCsrfToken()

    response.assertStatus(200)

    const updatedExploitation = await Exploitation.findBy({ id: existingExploitation.id })
    assert.equal(updatedExploitation?.isDeleted, true)

    response.assertRedirectsTo(route('exploitations.index'))
  })
})
