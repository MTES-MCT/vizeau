import testUtils from '@adonisjs/core/services/test_utils'
import { test } from '@japa/runner'
import { UserFactory } from '#database/factories/user_factory'
import { ExploitationFactory } from '#database/factories/exploitation_factory'
import Exploitation from '#models/exploitation'

test.group('Exploitation - Create Resource', (group) => {
  group.each.setup(() => testUtils.db().withGlobalTransaction())

  test('I can create a new Exploitation', async ({ assert, client, route }) => {
    const user = await UserFactory.create()
    const fakeExploitation = await ExploitationFactory.make()
    const exploitationPayload = {
      ...fakeExploitation.toJSON(),
      location: { x: '2.3522', y: '48.8566' },
    }

    const response = await client
      .post(route('exploitations.store'))
      .loginAs(user)
      .json(exploitationPayload)
      .withCsrfToken()

    const savedExploitation = await Exploitation.findBy({ name: fakeExploitation.name })
    assert.isNotNull(savedExploitation)

    response.assertRedirectsTo(route('exploitations.index'))
  })

  test('I can create a new Exploitation with a contact', async ({ assert, client, route }) => {
    const user = await UserFactory.create()
    const fakeExploitation = await ExploitationFactory.make()
    const exploitationPayload = {
      ...fakeExploitation.toJSON(),
      location: { x: '2.3522', y: '48.8566' },
      contacts: [
        {
          firstName: 'Jane',
          lastName: 'Doe',
        },
      ],
    }

    const response = await client
      .post(route('exploitations.store'))
      .loginAs(user)
      .json(exploitationPayload)
      .withCsrfToken()

    const savedExploitation = await Exploitation.findBy({ name: fakeExploitation.name })
    assert.isNotNull(savedExploitation)

    await savedExploitation?.load('contacts')
    assert.equal(savedExploitation?.contacts.length, 1)
    assert.equal(savedExploitation?.contacts[0].firstName, 'Jane')

    response.assertRedirectsTo(route('exploitations.index'))
  })

  test("I can't create an Exploitation without a name", async ({ client, route }) => {
    const user = await UserFactory.create()
    const fakeExploitation = await ExploitationFactory.make()
    fakeExploitation.name = undefined as any
    const exploitationPayload = {
      ...fakeExploitation.toJSON(),
      location: { x: '2.3522', y: '48.8566' },
      contacts: [
        {
          firstName: 'Jane',
          lastName: 'Doe',
        },
      ],
    }

    const response = await client
      .post(route('exploitations.store'))
      // Ensure we expect JSON response for validation errors and a 422 status code instead of a redirect
      .header('Accept', 'application/json')
      .loginAs(user)
      .json(exploitationPayload)
      .withCsrfToken()

    response.assertStatus(422)
  })
})
