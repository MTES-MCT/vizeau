import { test } from '@japa/runner'
import testUtils from '@adonisjs/core/services/test_utils'
import { UserFactory } from '#database/factories/user_factory'
import { ExploitationFactory } from '#database/factories/exploitation_factory'

test.group('Exploitation - Get Resource', (group) => {
  group.each.setup(() => testUtils.db().withGlobalTransaction())

  test('I can get an active exploitation by siret', async ({ assert, client, route }) => {
    const siret = '12345678901234'
    const user = await UserFactory.create()
    const exploitation = await ExploitationFactory.merge({ siret, userId: user.id }).create()

    const response = await client.get(route('exploitations.getBySiret', { siret })).loginAs(user)

    response.assertStatus(200)
    const responseBody = response.body()
    assert.equal(responseBody.id, exploitation.id)
    assert.equal(responseBody.siret, siret)
  })

  test("Getting an exploitation by siret that doesn't exist returns an empty object", async ({
    assert,
    client,
    route,
  }) => {
    const siret = '00000000000000'
    const user = await UserFactory.create()

    const response = await client.get(route('exploitations.getBySiret', { siret })).loginAs(user)

    response.assertStatus(204)
    assert.deepEqual(response.body(), {})
  })
})
