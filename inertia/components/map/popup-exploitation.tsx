import { fr } from '@codegouvfr/react-dsfr'
import LabelInfo from '~/ui/LabelInfo'
import { ExploitationJson, ParcelleJson } from '../../../types/models'

function CalculateSurfaceTotale(parcelles: ParcelleJson[]) {
  const totalSurface = parcelles.reduce((total: number, parcelle: ParcelleJson) => {
    const surface = parcelle.surface || 0
    return total + surface
  }, 0)

  const nbParcelles = parcelles.length

  return {
    surface: totalSurface.toFixed(2),
    nbParcelles,
  }
}

export default function PopupExploitation({ exploitation }: { exploitation: ExploitationJson }) {
  const parcelles = exploitation.parcelles || []
  const surfaceTotale = CalculateSurfaceTotale(parcelles)

  return (
    <div
      style={{
        backgroundColor: fr.colors.decisions.background.default.grey.default,
        minWidth: '300px',
      }}
    >
      <div className="fr-p-1w text-lg fr-pb-2w">{exploitation.name}</div>
      <div className="flex flex-col gap-1">
        <LabelInfo
          label="Surface totale"
          icon="fr-icon-ruler-line"
          info={
            parcelles.length > 0
              ? `${surfaceTotale.surface} ha (${surfaceTotale.nbParcelles} parcelles)`
              : 'Pas de parcelles associÃ©es'
          }
          size="sm"
        />
        <LabelInfo
          label="Adresse"
          icon="fr-icon-map-pin-2-line"
          info={
            exploitation.commune
              ? `${exploitation.addressLine1 || ''} ${exploitation.postalCode || ''} ${exploitation.commune}`
              : 'N/A'
          }
          size="sm"
        />
        <LabelInfo
          label="Contact"
          icon="fr-icon-user-star-line"
          info={
            exploitation.contacts && exploitation.contacts.length > 0
              ? `${exploitation.contacts[0]?.firstName || ''} ${exploitation.contacts[0]?.lastName || ''}`
              : 'N/A'
          }
          size="sm"
        />
      </div>
    </div>
  )
}
