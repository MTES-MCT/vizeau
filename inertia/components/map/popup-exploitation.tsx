import { fr } from '@codegouvfr/react-dsfr'
import LabelInfo from '~/ui/LabelInfo'
import { ExploitationJson, ParcelleJson } from '../../../types/models'
import TagsList from '~/ui/TagsList'
import { displayContactName, getMainContact } from '~/functions/contacts'

function calculateSurfaceTotale(parcelles: ParcelleJson[]) {
  const totalSurface = parcelles.reduce((total, parcelle) => {
    const surfaceStr = String(parcelle.surface || '0')
    const surface = parseFloat(surfaceStr)
    return total + surface
  }, 0)

  const nbParcelles = parcelles.length

  return {
    surface: totalSurface.toFixed(2),
    nbParcelles,
  }
}

export default function PopupExploitation({ exploitation }: { exploitation: ExploitationJson }) {
  const parcelles = exploitation.parcelles || []
  const surfaceTotale = calculateSurfaceTotale(parcelles)
  const mainContact = getMainContact(exploitation.contacts ?? undefined)

  return (
    <div
      style={{
        backgroundColor: fr.colors.decisions.background.default.grey.default,
        fontFamily: 'Marianne, arial, sans-serif',
        maxWidth: '400px',
      }}
    >
      <div className="fr-p-1w text-lg fr-pb-2w">{exploitation.name}</div>
      <div className="flex flex-col gap-1">
        <LabelInfo
          label="Surface totale"
          icon="fr-icon-ruler-line"
          info={
            parcelles.length > 0
              ? `${surfaceTotale.surface} ha (${surfaceTotale.nbParcelles} parcelles)`
              : 'Pas de parcelles associÃ©es'
          }
          size="sm"
        />
        <LabelInfo
          label="Adresse"
          icon="fr-icon-map-pin-2-line"
          info={
            exploitation.commune
              ? [exploitation.addressLine1, exploitation.postalCode, exploitation.commune]
                  .filter(Boolean)
                  .join(' ')
              : 'N/A'
          }
          size="sm"
        />
        <LabelInfo
          label="Contact"
          icon="fr-icon-user-star-line"
          info={displayContactName(mainContact)}
          size="sm"
        />
        {exploitation.tags && exploitation.tags.length > 0 && (
          <LabelInfo
            label="Types d'agriculture"
            icon="fr-icon-leaf-line"
            info={
              <TagsList
                tags={exploitation.tags.map((tag) => ({ label: tag.name }))}
                limit={3}
                size="sm"
              />
            }
            size="sm"
          />
        )}
      </div>
    </div>
  )
}
