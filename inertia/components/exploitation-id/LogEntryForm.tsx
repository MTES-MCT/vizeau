import { Input } from '@codegouvfr/react-dsfr/Input'
import SectionCard from '~/ui/SectionCard'
import { TagSelector } from '~/components/exploitation-id/TagSelector'
import { LogEntryFormData } from '~/pages/journal/creation'
import { SetDataAction } from '@inertiajs/react'
import { formatDateFr } from '~/functions/date'
import { useState } from 'react'
import { Checkbox } from '@codegouvfr/react-dsfr/Checkbox'
import { Upload } from '@codegouvfr/react-dsfr/Upload'
import FileItemsList from '~/ui/FileItemList'
import { LogEntryDocumentJson } from '../../../types/models'

type EntryLogFormProps = {
  data: LogEntryFormData
  setData: SetDataAction<LogEntryFormData>
  inputValue: string
  setInputValue: (val: string) => void
  existingDocuments: Array<LogEntryDocumentJson>
  disabled?: boolean
}

export function LogEntryForm({
  data,
  setData,
  inputValue,
  setInputValue,
  existingDocuments,
  disabled = false,
}: EntryLogFormProps) {
  const [displayDocSubForm, setDisplayDocSubForm] = useState(existingDocuments.length > 0)
  return (
    <>
      {!disabled ? (
        <Input
          label="Titre"
          nativeInputProps={{
            name: 'title',
            maxLength: 255,
            value: data.title,
            onChange: (e) => setData('title', e.target.value),
          }}
        />
      ) : (
        <SectionCard size="small" background="secondary" icon="fr-icon-draft-line" title="Titre">
          <p>{data.title || <i>Cette tâche n'a pas de titre.</i>}</p>
        </SectionCard>
      )}
      {!disabled ? (
        <Input
          label="Date de la tâche"
          nativeInputProps={{
            name: 'date',
            type: 'date',
            value: data.date,
            onChange: (e) => setData('date', e.target.value),
          }}
        />
      ) : (
        <SectionCard size="small" background="secondary" icon="fr-icon-calendar-line" title="Date">
          <p>{data.date ? formatDateFr(data.date) : <i>Cette tâche n'a pas de date.</i>}</p>
        </SectionCard>
      )}
      <SectionCard size="small" background="secondary" icon="fr-icon-draft-line" title="Notes">
        {!disabled ? (
          <Input
            textArea
            label=""
            nativeTextAreaProps={{
              name: 'notes',
              maxLength: 1000,
              value: data.notes,
              rows: 5,
              onChange: (e) => setData('notes', e.target.value),
            }}
          />
        ) : (
          <p>{data.notes || <i>Aucune note enregistrée.</i>}</p>
        )}
      </SectionCard>
      <SectionCard size="small" background="secondary" icon="fr-icon-star-line" title="Étiquettes">
        <TagSelector
          inputValue={inputValue}
          setInputValue={setInputValue}
          logEntryId={data.id}
          values={data.tags}
          onChange={(tags) => setData('tags', tags)}
          disabled={disabled}
        />
      </SectionCard>
      <Checkbox
        options={[
          {
            label: 'Ajouter des documents',
            nativeInputProps: {
              name: 'displayDocSubForm',
              value: 'true',
              checked: displayDocSubForm,
              onChange: (e) => {
                setDisplayDocSubForm(e.target.checked)
                if (!e.target.checked) {
                  setData('documents', [])
                }
              },
            },
          },
        ]}
      />
      {displayDocSubForm && (
        <SectionCard
          size="small"
          background="secondary"
          icon="fr-icon-attachment-line"
          title="Documents"
        >
          <Upload
            label=""
            hint="Format PDF, maximum 10 Mo"
            multiple={true}
            disabled={disabled}
            nativeInputProps={{
              accept: 'application/pdf',
              onChange: (e) => {
                if (e.target.files) {
                  const files = []
                  for (let i = 0; i < e.target.files.length; i++) {
                    files.push(e.target.files[i])
                  }
                  setData('documents', files)
                }
              },
            }}
          />
          {existingDocuments && existingDocuments.length > 0 && (
            <>
              <div className="fr-mt-2w fr-mb-1w text-md font-bold">Fichiers déjà téléchargés :</div>
              <div className="bg-white">
                <FileItemsList
                  files={existingDocuments?.map((document) => ({
                    name: document.name,
                    href: document.href,
                    size: document.sizeInBytes,
                    format: 'PDF',
                  }))}
                />
              </div>
            </>
          )}
        </SectionCard>
      )}
    </>
  )
}
