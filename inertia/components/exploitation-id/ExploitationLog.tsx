import { router, useForm, usePage } from '@inertiajs/react'
import { InferPageProps, SharedProps } from '@adonisjs/inertia/types'
import ExploitationsController from '#controllers/exploitations_controller'
import { Button } from '@codegouvfr/react-dsfr/Button'
import { createModal } from '@codegouvfr/react-dsfr/Modal'
import { FormEvent, useState } from 'react'
import { EntryLogForm } from '~/components/exploitation-id/EntryLogForm'
import { LogEntryTagJson } from '../../../types/models'

const editEntryLogModal = createModal({
  id: 'edit-entry-log-modal',
  isOpenedByDefault: false,
})

export function ExploitationLog() {
  const { exploitation, editEntryLogUrl, deleteEntryLogUrl } =
    usePage<InferPageProps<ExploitationsController, 'get'>>().props
  const { user } = usePage<SharedProps>().props
  const [inputValue, setInputValue] = useState('')
  const { data, setData, patch, resetAndClearErrors } = useForm<{
    id: string
    isAuthor: boolean
    notes: string
    tags: number[]
  }>({
    id: '',
    // We can submit only if we are the author
    isAuthor: false,
    notes: '',
    tags: [],
  })

  const handleSubmit = (e: FormEvent) => {
    e.preventDefault()
    patch(editEntryLogUrl, {
      onSuccess: () => {
        setInputValue('')
        resetAndClearErrors()
      },
    })
  }

  // Placeholder component - to be replaced with actual log entries rendering
  return (
    <>
      <ul>
        {exploitation.logEntries ? (
          exploitation.logEntries.map((logEntry) => (
            <li key={logEntry.id}>
              {logEntry.notes || new Date(logEntry.createdAt).toLocaleDateString()}
              <Button
                type="button"
                onClick={() => {
                  setData({
                    id: logEntry.id,
                    isAuthor: logEntry.userId === user.id,
                    notes: logEntry.notes || '',
                    tags: logEntry.tags?.map((tag: LogEntryTagJson) => tag.id) || [],
                  })
                  editEntryLogModal.open()
                }}
                title="Voir"
                size="small"
                priority="tertiary"
              >
                {logEntry.userId === user.id ? 'Éditer' : 'Voir'}
              </Button>
              {logEntry.userId === user.id && (
                <Button
                  title={'Supprimer'}
                  iconId={'fr-icon-delete-line'}
                  size={'small'}
                  priority={'tertiary'}
                  onClick={() => {
                    router.delete(deleteEntryLogUrl, {
                      data: { id: logEntry.id },
                    })
                  }}
                >
                  Supprimer
                </Button>
              )}
            </li>
          ))
        ) : (
          <li>Aucune entrée dans le journal.</li>
        )}
      </ul>
      <form onSubmit={handleSubmit}>
        <editEntryLogModal.Component
          size="large"
          title={
            <>
              <span className="fr-icon-pen-nib-line fr-mr-1w" />
              Modification d'une entrée
            </>
          }
          buttons={[
            {
              children: 'Retour',
              type: 'button',
              doClosesModal: true,
              onClick: () => {
                setInputValue('')
                resetAndClearErrors()
              },
            },
            {
              children: 'Valider',
              disabled:
                !data.isAuthor || (data.notes.trim().length === 0 && data.tags.length === 0),
              type: 'submit',
            },
          ]}
        >
          <EntryLogForm
            data={data}
            setData={setData}
            inputValue={inputValue}
            setInputValue={setInputValue}
            disabled={!data.isAuthor}
          />
        </editEntryLogModal.Component>
      </form>
    </>
  )
}
