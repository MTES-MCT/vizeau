import { router, usePage } from '@inertiajs/react'
import { InferPageProps, SharedProps } from '@adonisjs/inertia/types'
import ExploitationsController from '#controllers/exploitations_controller'
import { createModal } from '@codegouvfr/react-dsfr/Modal'
import { ReactNode, useState } from 'react'
import Alert from '@codegouvfr/react-dsfr/Alert'
import EmptyPlaceholder from '~/ui/EmptyPlaceholder'
import Timeline, { TimelineItem } from '~/ui/Timeline'
import ListItem from '~/ui/ListItem'
import {
  getLogEntryAdditionalInfos,
  getLogEntryTitle,
  severityColorMap,
} from '~/functions/log_entries'
import AlertDrawer from '~/ui/AlertDrawer'
import { MoreButtonProps } from '~/ui/MoreButton'

const deleteEntryLogModal = createModal({
  id: 'delete-entry-log-modal',
  isOpenedByDefault: false,
})

const completeEntryLogModal = createModal({
  id: 'complete-entry-log-modal',
  isOpenedByDefault: false,
})

export function ExploitationLog({ exploitationId }: { exploitationId: string }) {
  const { logEntries, logEntriesMeta, deleteEntryLogUrl, completeEntryLogUrl } =
    usePage<InferPageProps<ExploitationsController, 'get'>>().props
  const { user } = usePage<SharedProps>().props
  const [logEntryToDelete, setLogEntryToDelete] = useState<string>('')
  const [logEntryToComplete, setLogEntryToComplete] = useState<string>('')

  if (logEntries?.length === 0) {
    return (
      <EmptyPlaceholder
        illustrativeIcon="fr-icon-booklet-line"
        label="Votre tableau de bord est vide."
        hint="Ajoutez une tâche pour commencer à suivre vos informations."
      />
    )
  }

  const timelineItems: TimelineItem[] = []
  const urgentListItems: ReactNode[] = []

  for (const logEntry of logEntries) {
    const additionalInfos = getLogEntryAdditionalInfos(logEntry)
    const actions: MoreButtonProps['actions'] = [
      {
        label: 'Éditer',
        iconId: 'fr-icon-edit-line',
        isHidden: logEntry.userId !== user.id,
        onClick: () => {
          const url = `/exploitations/${exploitationId}/journal/${logEntry.id}/edition`
          router.visit(url)
        },
      },
      {
        label: 'Supprimer',
        isCritical: logEntry.userId === user.id,
        isHidden: logEntry.userId !== user.id,
        iconId: 'fr-icon-delete-line',
        onClick: () => {
          setLogEntryToDelete(logEntry.id)
          deleteEntryLogModal.open()
        },
      },
    ]

    if (logEntry.date && !logEntry.isCompleted) {
      actions.push({
        label: 'Marquer comme effectuée',
        iconId: 'fr-icon-check-line',
        onClick: () => {
          setLogEntryToComplete(logEntry.id)
          completeEntryLogModal.open()
        },
      })
    }

    const listItem: ReactNode = (
      <ListItem
        variant="compact"
        key={logEntry.id}
        title={getLogEntryTitle(logEntry)}
        linkProps={{ href: `/exploitations/${exploitationId}/journal/${logEntry.id}` }}
        tags={logEntry.tags?.map((tag) => ({ label: tag.name })) || []}
        additionalInfos={logEntry.date ? additionalInfos : undefined}
        hasBorder={true}
        metas={[
          {
            content: `Créée le ${new Date(logEntry.createdAt).toLocaleDateString()}`,
            iconId: 'fr-icon-calendar-event-line',
          },
        ]}
        actions={actions}
      />
    )

    timelineItems.push({
      content: listItem,
      dotColor:
        additionalInfos.alert && additionalInfos.alert.severity
          ? severityColorMap[additionalInfos.alert.severity]
          : undefined,
    })
    if (
      additionalInfos.alert?.severity === 'error' ||
      additionalInfos.alert?.severity === 'warning'
    ) {
      urgentListItems.push(listItem)
    }
  }

  return (
    <>
      {urgentListItems.length > 0 && (
        <AlertDrawer
          title="Tâches urgentes et à venir"
          severity="warning"
          customIconId="fr-icon-notification-3-line"
        >
          <div className={'flex flex-col gap-3'}>{urgentListItems}</div>
        </AlertDrawer>
      )}

      <Timeline
        items={timelineItems}
        onShowMore={() => {
          return new Promise((resolve) => {
            router.reload({
              only: ['logEntries', 'logEntriesMeta'],
              replace: true,
              data: { page: logEntriesMeta.currentPage + 1 },
              preserveUrl: true,
              onFinish: () => resolve(),
            })
          })
        }}
        hasMore={logEntriesMeta.currentPage < logEntriesMeta.lastPage}
      />
      <deleteEntryLogModal.Component
        title=""
        size="large"
        buttons={[
          { children: 'Annuler', doClosesModal: true },
          {
            children: "Supprimer l'entrée de journal de bord",
            onClick: () => {
              router.delete(deleteEntryLogUrl, {
                data: { id: logEntryToDelete },
              })
            },
          },
        ]}
      >
        <Alert
          severity="error"
          title="Suppression d'une entrée de journal de bord"
          description="Vous êtes sur le point de supprimer cette entrée de journal de bord, voulez-vous continuer ?"
        />
      </deleteEntryLogModal.Component>
      <completeEntryLogModal.Component
        title=""
        size="large"
        buttons={[
          { children: 'Annuler', doClosesModal: true },
          {
            children: 'Marquer comme effectuée',
            onClick: () => {
              router.post(completeEntryLogUrl, {
                id: logEntryToComplete,
              })
            },
          },
        ]}
      >
        <Alert
          severity="warning"
          title="Complétion d'une tâche planifiée"
          description="Vous êtes sur le point de marquer cette tâche comme effectuée, voulez-vous continuer ?"
        />
      </completeEntryLogModal.Component>
    </>
  )
}
