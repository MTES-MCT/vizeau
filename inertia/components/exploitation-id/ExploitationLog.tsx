import { router, useForm, usePage } from '@inertiajs/react'
import { InferPageProps, SharedProps } from '@adonisjs/inertia/types'
import ExploitationsController from '#controllers/exploitations_controller'
import { createModal } from '@codegouvfr/react-dsfr/Modal'
import { FormEvent, useState } from 'react'
import { EntryLogForm } from '~/components/exploitation-id/EntryLogForm'
import { LogEntryTagJson } from '../../../types/models'
import Alert from '@codegouvfr/react-dsfr/Alert'
import EmptyPlaceholder from '~/ui/EmptyPlaceholder'
import Timeline, { TimelineItem } from '~/ui/Timeline'
import CompactListItem from '~/ui/CompactListItem'

const editEntryLogModal = createModal({
  id: 'edit-entry-log-modal',
  isOpenedByDefault: false,
})

const deleteEntryLogModal = createModal({
  id: 'delete-entry-log-modal',
  isOpenedByDefault: false,
})

export function ExploitationLog({
  handlePlaceholderAction,
}: {
  handlePlaceholderAction: () => void
}) {
  const { logEntries, logEntriesMeta, editEntryLogUrl, deleteEntryLogUrl } =
    usePage<InferPageProps<ExploitationsController, 'get'>>().props
  const { user } = usePage<SharedProps>().props
  const [inputValue, setInputValue] = useState('')
  const [logEntryToDelete, setLogEntryToDelete] = useState<string>('')
  const { data, setData, patch, resetAndClearErrors } = useForm<{
    id: string
    isAuthor: boolean
    notes: string
    tags: number[]
  }>({
    id: '',
    // We can submit only if we are the author
    isAuthor: false,
    notes: '',
    tags: [],
  })

  const handleSubmit = (e: FormEvent) => {
    e.preventDefault()
    patch(editEntryLogUrl, {
      onSuccess: () => {
        setInputValue('')
        resetAndClearErrors()
      },
    })
  }

  if (!logEntries) {
    return (
      <EmptyPlaceholder
        illustrativeIcon="fr-icon-booklet-line"
        label="Votre tableau de bord est vide."
        hint="Ajoutez une action pour commencer à suivre vos informations."
        buttonIcon="fr-icon-add-line"
        buttonLabel="Ajouter votre première action"
        handleClick={handlePlaceholderAction}
      />
    )
  }

  const timelineItems: TimelineItem[] = logEntries.map((logEntry) => ({
    content: (
      <CompactListItem
        key={logEntry.id}
        label={logEntry.notes || new Date(logEntry.createdAt).toLocaleDateString()}
        tags={logEntry.tags?.map((tag) => ({ label: tag.name })) || []}
        metas={[
          {
            content: new Date(logEntry.createdAt).toLocaleDateString(),
            iconId: 'fr-icon-calendar-event-line',
          },
        ]}
        actions={[
          {
            label: logEntry.userId === user.id ? 'Éditer' : 'Voir',
            iconId: logEntry.userId === user.id ? 'fr-icon-edit-line' : 'fr-icon-arrow-right-line',
            onClick: () => {
              setData({
                id: logEntry.id,
                isAuthor: logEntry.userId === user.id,
                notes: logEntry.notes || '',
                tags: logEntry.tags?.map((tag: LogEntryTagJson) => tag.id) || [],
              })
              editEntryLogModal.open()
            },
          },
          {
            label: 'Supprimer',
            isCritical: logEntry.userId === user.id,
            isDisabled: logEntry.userId !== user.id,
            iconId: 'fr-icon-delete-line',
            onClick: () => {
              setLogEntryToDelete(logEntry.id)
              deleteEntryLogModal.open()
            },
          },
        ]}
      />
    ),
  }))

  return (
    <>
      <Timeline
        items={timelineItems}
        onShowMore={() => {
          return new Promise((resolve) => {
            router.reload({
              only: ['logEntries', 'logEntriesMeta'],
              replace: true,
              data: { page: logEntriesMeta.currentPage + 1 },
              preserveUrl: true,
            })
            resolve()
          })
        }}
        hasMore={logEntriesMeta.currentPage < logEntriesMeta.lastPage}
      />
      <form onSubmit={handleSubmit}>
        <editEntryLogModal.Component
          size="large"
          title={
            <>
              <span className="fr-icon-pen-nib-line fr-mr-1w" />
              Modification d'une entrée
            </>
          }
          buttons={[
            {
              children: 'Retour',
              type: 'button',
              doClosesModal: true,
              onClick: () => {
                setInputValue('')
                resetAndClearErrors()
              },
            },
            {
              children: 'Valider',
              disabled:
                !data.isAuthor || (data.notes.trim().length === 0 && data.tags.length === 0),
              type: 'submit',
            },
          ]}
        >
          <EntryLogForm
            data={data}
            setData={setData}
            inputValue={inputValue}
            setInputValue={setInputValue}
            disabled={!data.isAuthor}
          />
        </editEntryLogModal.Component>
      </form>
      <deleteEntryLogModal.Component
        title=""
        size="large"
        buttons={[
          { children: 'Annuler', doClosesModal: true },
          {
            children: "Supprimer l'entrée de journal de bord",
            onClick: () => {
              router.delete(deleteEntryLogUrl, {
                data: { id: logEntryToDelete },
              })
            },
          },
        ]}
      >
        <Alert
          severity="error"
          title="Suppression d'une entrée de journal de bord"
          description="Vous êtes sur le point de supprimer cette entrée de journal de bord, voulez-vous continuer ?"
        />
      </deleteEntryLogModal.Component>
    </>
  )
}
