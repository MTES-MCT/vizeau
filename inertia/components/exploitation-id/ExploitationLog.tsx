import { router, usePage } from '@inertiajs/react'
import { InferPageProps, SharedProps } from '@adonisjs/inertia/types'
import ExploitationsController from '#controllers/exploitations_controller'
import { createModal } from '@codegouvfr/react-dsfr/Modal'
import { useState } from 'react'
import Alert from '@codegouvfr/react-dsfr/Alert'
import EmptyPlaceholder from '~/ui/EmptyPlaceholder'
import Timeline, { TimelineItem } from '~/ui/Timeline'
import ListItem from '~/ui/ListItem'

const deleteEntryLogModal = createModal({
  id: 'delete-entry-log-modal',
  isOpenedByDefault: false,
})

export function ExploitationLog({
  exploitationId,
  handlePlaceholderAction,
}: {
  handlePlaceholderAction: () => void
  exploitationId: string
}) {
  const { logEntries, logEntriesMeta, deleteEntryLogUrl } =
    usePage<InferPageProps<ExploitationsController, 'get'>>().props
  const { user } = usePage<SharedProps>().props
  const [logEntryToDelete, setLogEntryToDelete] = useState<string>('')

  if (logEntries?.length === 0) {
    return (
      <EmptyPlaceholder
        illustrativeIcon="fr-icon-booklet-line"
        label="Votre tableau de bord est vide."
        hint="Ajoutez une action pour commencer à suivre vos informations."
        buttonIcon="fr-icon-add-line"
        buttonLabel="Ajouter votre première action"
        handleClick={handlePlaceholderAction}
      />
    )
  }

  const timelineItems: TimelineItem[] = logEntries.map((logEntry) => ({
    content: (
      <ListItem
        variant="compact"
        key={logEntry.id}
        title={logEntry.notes || new Date(logEntry.createdAt).toLocaleDateString()}
        tags={logEntry.tags?.map((tag) => ({ label: tag.name })) || []}
        metas={
          // If there are notes, show the date as meta. Otherwise, the date is the main label
          logEntry.notes
            ? [
                {
                  content: new Date(logEntry.createdAt).toLocaleDateString(),
                  iconId: 'fr-icon-calendar-event-line',
                },
              ]
            : []
        }
        actions={[
          {
            label: logEntry.userId === user.id ? 'Éditer' : 'Voir',
            iconId: logEntry.userId === user.id ? 'fr-icon-edit-line' : 'fr-icon-arrow-right-line',
            onClick: () => {
              router.visit(`/exploitations/${exploitationId}/journal/${logEntry.id}`)
            },
          },
          {
            label: 'Supprimer',
            isCritical: logEntry.userId === user.id,
            isDisabled: logEntry.userId !== user.id,
            iconId: 'fr-icon-delete-line',
            onClick: () => {
              setLogEntryToDelete(logEntry.id)
              deleteEntryLogModal.open()
            },
          },
        ]}
      />
    ),
  }))

  return (
    <>
      <Timeline
        items={timelineItems}
        onShowMore={() => {
          return new Promise((resolve) => {
            router.reload({
              only: ['logEntries', 'logEntriesMeta'],
              replace: true,
              data: { page: logEntriesMeta.currentPage + 1 },
              preserveUrl: true,
              onFinish: () => resolve(),
            })
          })
        }}
        hasMore={logEntriesMeta.currentPage < logEntriesMeta.lastPage}
      />
      <deleteEntryLogModal.Component
        title=""
        size="large"
        buttons={[
          { children: 'Annuler', doClosesModal: true },
          {
            children: "Supprimer l'entrée de journal de bord",
            onClick: () => {
              router.delete(deleteEntryLogUrl, {
                data: { id: logEntryToDelete },
              })
            },
          },
        ]}
      >
        <Alert
          severity="error"
          title="Suppression d'une entrée de journal de bord"
          description="Vous êtes sur le point de supprimer cette entrée de journal de bord, voulez-vous continuer ?"
        />
      </deleteEntryLogModal.Component>
    </>
  )
}
