import SectionCard from '~/ui/SectionCard'
import { ExploitationLog } from '~/components/exploitation-id/ExploitationLog'
import { createModal } from '@codegouvfr/react-dsfr/Modal'
import { useForm, usePage } from '@inertiajs/react'
import { InferPageProps } from '@adonisjs/inertia/types'
import ExploitationsController from '#controllers/exploitations_controller'
import { FlashMessages } from '~/components/flash-message'
import { FormEvent, useState } from 'react'
import { EntryLogForm } from '~/components/exploitation-id/EntryLogForm'

const createEntryLogModal = createModal({
  id: 'create-entry-log-modal',
  isOpenedByDefault: false,
})

export function ExploitationMainColumn() {
  const { createEntryLogUrl, flashMessages } =
    usePage<InferPageProps<ExploitationsController, 'get'>>().props
  const [inputValue, setInputValue] = useState('')
  const { data, setData, post, resetAndClearErrors } = useForm<{
    notes: string
    tags: number[]
  }>({
    notes: '',
    tags: [],
  })

  const handleSubmit = (e: FormEvent) => {
    e.preventDefault()
    post(createEntryLogUrl, {
      onSuccess: () => {
        setInputValue('')
        resetAndClearErrors()
      },
    })
  }

  return (
    <>
      <SectionCard
        title="Journal de bord"
        actionIcon="fr-icon-add-line"
        actionLabel="Ajouter une nouvelle entrée"
        handleAction={createEntryLogModal.open}
      >
        <FlashMessages flashMessages={flashMessages} />
        <ExploitationLog />
      </SectionCard>
      <form onSubmit={handleSubmit}>
        <createEntryLogModal.Component
          size="large"
          title={
            <>
              <span className="fr-icon-pen-nib-line fr-mr-1w" />
              Nouvelle entrée
            </>
          }
          buttons={[
            {
              children: 'Retour',
              type: 'button',
              doClosesModal: true,
              onClick: () => {
                setInputValue('')
                resetAndClearErrors()
              },
            },
            {
              children: 'Valider',
              disabled: data.notes.trim().length === 0 && data.tags.length === 0,
              type: 'submit',
            },
          ]}
        >
          <EntryLogForm
            data={data}
            setData={setData}
            inputValue={inputValue}
            setInputValue={setInputValue}
          />
        </createEntryLogModal.Component>
      </form>
    </>
  )
}
