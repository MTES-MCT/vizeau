import SectionCard from '~/ui/SectionCard'
import { ExploitationLog } from '~/components/exploitation-id/ExploitationLog'
import { Input } from '@codegouvfr/react-dsfr/Input'
import { createModal } from '@codegouvfr/react-dsfr/Modal'
import { useForm, usePage } from '@inertiajs/react'
import { InferPageProps } from '@adonisjs/inertia/types'
import ExploitationsController from '#controllers/exploitations_controller'
import { FlashMessages } from '~/components/flash-message'
import { TagSelector } from '~/components/exploitation-id/TagSelector'
import { FormEvent, useState } from 'react'

const createEntryLogModal = createModal({
  id: 'create-entry-log-modal',
  isOpenedByDefault: false,
})

export function ExploitationMainColumn() {
  const { createEntryLogUrl, flashMessages } =
    usePage<InferPageProps<ExploitationsController, 'get'>>().props
  const [inputValue, setInputValue] = useState('')
  const { data, setData, post, resetAndClearErrors } = useForm<{
    notes: string
    tags: number[]
  }>({
    notes: '',
    tags: [],
  })

  const handleSubmit = (e: FormEvent) => {
    e.preventDefault()
    post(createEntryLogUrl, {
      onSuccess: () => {
        setInputValue('')
        resetAndClearErrors()
      },
    })
  }

  return (
    <>
      <SectionCard
        title="Journal de bord"
        actionIcon="fr-icon-add-line"
        actionLabel="Ajouter une nouvelle entrée"
        handleAction={createEntryLogModal.open}
      >
        <FlashMessages flashMessages={flashMessages} />
        <ExploitationLog />
      </SectionCard>
      <form onSubmit={handleSubmit}>
        <createEntryLogModal.Component
          size="large"
          title={
            <>
              <span className="fr-icon-pen-nib-line fr-mr-1w" />
              Nouvelle entrée
            </>
          }
          buttons={[
            {
              children: 'Retour',
              type: 'button',
              doClosesModal: true,
              onClick: () => {
                setInputValue('')
                resetAndClearErrors()
              },
            },
            {
              children: 'Valider',
              disabled: data.notes.trim().length === 0 && data.tags.length === 0,
              type: 'submit',
            },
          ]}
        >
          <Input
            textArea
            label="Note"
            nativeTextAreaProps={{
              name: 'notes',
              maxLength: 1000,
              value: data.notes,
              onChange: (e) => setData('notes', e.target.value),
            }}
          />
          <div className="fr-pb-15w">
            <SectionCard
              size="small"
              background="secondary"
              icon="fr-icon-star-line"
              title="Étiquettes"
            >
              <TagSelector
                inputValue={inputValue}
                setInputValue={setInputValue}
                values={data.tags}
                onChange={(tags) => setData('tags', tags)}
              />
            </SectionCard>
          </div>
        </createEntryLogModal.Component>
      </form>
    </>
  )
}
