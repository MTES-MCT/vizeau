import { ChangeEvent, RefObject } from 'react'
import { Link, router } from '@inertiajs/react'
import { fr } from '@codegouvfr/react-dsfr'
import ListItem from '~/ui/ListItem'
import { ExploitationJson } from '../../../types/models'
import SearchBar from '@codegouvfr/react-dsfr/SearchBar'
import Breadcrumb from '@codegouvfr/react-dsfr/Breadcrumb'
import Button from '@codegouvfr/react-dsfr/Button'
import { VisualisationMapRef } from '~/components/map/VisualisationMap'
import ParcellesSection from '../parcelle/parcelles-section'
import ParcellesManager from '../parcelles-manager'
import Tabs from '~/ui/Tabs'
import VisualisationExploitationGeneral from '../visualisation-exploitation-general'

export default function ExploitationLeftSidebar({
  exploitations,
  queryString,
  handleSearch,
  selectedExploitation,
  selectedExploitationTab,
  setSelectedExploitationTab,
  isMapLoading,
  editMode,
  mapRef,
  setData,
  setDefaults,
  setEditMode,
  showBioOnly,
  millesime,
  isDirty,
  processing,
  reset,
  sendFormAndResetState,
}: {
  exploitations: ExploitationJson[]
  queryString?: { recherche?: string }
  handleSearch: (e: ChangeEvent<HTMLInputElement>) => void
  selectedExploitation?: ExploitationJson
  selectedExploitationTab: string
  setSelectedExploitationTab: (tab: string) => void
  isMapLoading: boolean
  editMode: boolean
  mapRef: RefObject<VisualisationMapRef>
  setData: any
  setDefaults: any
  setEditMode: any
  showBioOnly: boolean
  millesime: string
  isDirty: boolean
  processing: boolean
  reset: any
  sendFormAndResetState: any
}) {
  return (
    <div>
      {selectedExploitation ? (
        <div className="fr-p-1w">
          <Breadcrumb
            currentPageLabel={selectedExploitation?.name}
            segments={[
              {
                label: 'Liste des exploitations agricoles',
                linkProps: {
                  href: '#',
                  onClick: () => {
                    // Only allow going back to the list if not in edit mode
                    if (!editMode) {
                      router.visit(`/visualisation?millesime=${millesime}`)
                    }
                  },
                  style: {
                    cursor: !editMode ? 'pointer' : 'not-allowed',
                    // href "#" transforms the link into a button with blue text, we override it to look like a normal link
                    fontSize: 'inherit',
                    color: 'inherit',
                  },
                },
              },
            ]}
            style={{ marginBottom: fr.spacing('2v') }}
            className="fr-m-1w"
          />
          <div
            className="fr-p-1w fr-m-1w"
            style={{ background: fr.colors.decisions.background.alt.blueFrance.default }}
          >
            <div className="flex flex-col gap-4 fr-mb-1v">
              <Link
                href={`/exploitations/${selectedExploitation.id}`}
                as="h4"
                className="fr-m-0 font-bold fr-text--lead underline cursor-pointer"
              >
                {selectedExploitation?.name}
              </Link>
              <div
                className="flex flex-col gap-2 fr-mb-3v fr-pb-3v"
                style={{
                  borderBottom: `1px solid ${fr.colors.decisions.border.default.grey.default}`,
                }}
              >
                <Button
                  priority="secondary"
                  size="small"
                  iconId="fr-icon-crosshair-2-line"
                  className="flex justify-center"
                  onClick={() => {
                    if (selectedExploitation) {
                      mapRef.current?.centerOnExploitation(selectedExploitation)
                    }
                  }}
                  style={{ whiteSpace: 'nowrap', width: '100%' }}
                >
                  Centrer sur l'exploitation
                </Button>

                <ParcellesManager
                  editMode={editMode}
                  setData={setData}
                  selectedExploitation={selectedExploitation}
                  setDefaults={setDefaults}
                  setEditMode={setEditMode}
                  showBioOnly={showBioOnly}
                  millesime={millesime}
                  isDirty={isDirty}
                  processing={processing}
                  reset={reset}
                  sendFormAndResetState={sendFormAndResetState}
                />
              </div>
            </div>

            <div className="flex flex-col gap-4">
              <Tabs
                tabsList={[
                  { value: 'general', label: 'Général' },
                  { value: 'parcelles', label: 'Parcelles', isDisabled: editMode },
                ]}
                selectedTab={selectedExploitationTab}
                onTabChange={(value) => setSelectedExploitationTab(value)}
              />

              {selectedExploitationTab === 'general' && (
                <VisualisationExploitationGeneral exploitation={selectedExploitation} />
              )}

              {selectedExploitationTab === 'parcelles' && (
                <ParcellesSection
                  parcelles={selectedExploitation.parcelles ?? []}
                  exploitationId={selectedExploitation.id}
                />
              )}
            </div>
          </div>
        </div>
      ) : (
        <div className="fr-p-1w">
          <div className="flex">
            <SearchBar
              className="flex flex-1 fr-mb-2w"
              renderInput={({ className, id, type }) => (
                <input
                  className={className}
                  id={id}
                  placeholder="Rechercher une exploitation agricole"
                  type={type}
                  onChange={handleSearch}
                  defaultValue={queryString?.recherche || ''}
                />
              )}
            />
          </div>
          {exploitations.map((exploitation, index) => (
            <div
              onClick={() => {
                if (!isMapLoading) {
                  // Update URL to reflect the selected exploitation (without parcelleId)
                  router.visit(
                    `/visualisation?exploitationId=${exploitation.id}&millesime=${millesime}`,
                    {
                      preserveScroll: true,
                      preserveState: true,
                    }
                  )
                }
              }}
              style={{ cursor: !isMapLoading ? 'pointer' : 'progress' }}
              key={exploitation.id}
            >
              <ListItem
                title={
                  <div>
                    <span
                      className={
                        exploitation?.siret
                          ? 'fr-icon-building-line fr-pr-1w'
                          : 'fr-icon-user-line fr-pr-1w'
                      }
                      style={{ color: fr.colors.decisions.text.actionHigh.blueFrance.default }}
                      aria-hidden="true"
                    />
                    {exploitation.name}
                  </div>
                }
                subtitle={exploitation?.commune || 'N/A'}
                priority={index % 2 === 0 ? 'primary' : 'secondary'}
                tags={exploitation.tags?.map((tag) => ({ label: tag.name }))}
              />
            </div>
          ))}
        </div>
      )}
    </div>
  )
}
