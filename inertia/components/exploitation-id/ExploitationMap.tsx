import { useEffect, useRef } from 'react'

import maplibre from 'maplibre-gl'
import 'maplibre-gl/dist/maplibre-gl.css'

import planIGN from '../../styles/plan-ign.json'
import { ExploitationJson } from '../../../types/models'

export const ExploitationMap = ({ point }: { point: ExploitationJson['location'] }) => {
  if (!point) {
    return null
  }

  const mapContainerRef = useRef<HTMLDivElement>(null)
  const mapRef = useRef<maplibre.Map>(null)
  const pointArray: [number, number] = [point.x, point.y]

  useEffect(() => {
    if (!mapContainerRef.current) {
      return
    }

    const map = new maplibre.Map({
      container: mapContainerRef.current,
      style: planIGN as any,
      center: mapRef.current ? mapRef.current.getCenter() : pointArray,
      zoom: mapRef.current ? mapRef.current.getZoom() : 10,
      hash: true,
      attributionControl: false,
    })

    new maplibre.Marker().setLngLat(pointArray).addTo(map)

    mapRef.current = map

    return () => {
      map.remove()
    }
  }, [])

  return (
    <div className="flex h-[150px] w-full relative">
      <div ref={mapContainerRef} className="flex h-full w-full" />
    </div>
  )
}
