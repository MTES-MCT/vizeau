import { useState } from 'react'
import { fr } from '@codegouvfr/react-dsfr'
import Input from '@codegouvfr/react-dsfr/Input'

import MajorSelector from '~/ui/MajorSelector'
import SectionCard from '~/ui/SectionCard'
import SearchRaisonSociale from '~/components/search-raison-sociale'

import { ExploitationTagSelector } from '~/components/exploitations/form/ExploitationTagSelector'
import { ExploitationTagJson } from '../../../../types/models'
import { ExploitationFormValues } from '~/components/exploitations/form/exploitation-form'
import { SetDataAction } from '@inertiajs/react'
import { OptionType } from '~/ui/InputWithSelector'
import { typesActiviteAgricoleGroupLabels } from '~/functions/cultures_types'

// Auto mode means that the denominationLegale will be set automatically from the SIRET
const FormMode = { auto: 'auto', manual: 'manual' } as const

export default function ExploitationIdentification({
  exploitation,
  setExploitation,
  error,
  exploitationTags,
}: {
  exploitation: ExploitationFormValues
  setExploitation: SetDataAction<ExploitationFormValues>
  error?: { [key: string]: any }
  exploitationTags: ExploitationTagJson[]
}) {
  const [formMode, setFormMode] = useState<(typeof FormMode)[keyof typeof FormMode] | null>(null)

  const [exploitationTagInput, setExploitationTagInput] = useState('')
  const exploitationTagsOptions: OptionType<number>[] = exploitationTags.map((tag) => ({
    label: tag.name,
    value: tag.id,
    isSelected: (exploitation.tags && exploitation.tags.some((t) => t.id === tag.id)) || false,
    group: typesActiviteAgricoleGroupLabels[tag.group] || tag.group,
  }))

  return (
    <>
      <div className="fr-grid-row fr-grid-row--gutters fr-mt-6w">
        <div className="fr-col-6">
          <MajorSelector
            value={FormMode.auto}
            label="Avec raison sociale"
            icon="fr-icon-building-line"
            isSelected={formMode === FormMode.auto}
            getValue={() => {
              setFormMode(FormMode.auto)
            }}
          />
        </div>
        <div className="fr-col-6">
          <MajorSelector
            value={FormMode.manual}
            label="Sans raison sociale"
            icon="fr-icon-user-line"
            isSelected={formMode === FormMode.manual}
            getValue={() => {
              setFormMode(FormMode.manual)
            }}
          />
        </div>
      </div>
      {formMode && (
        <div className="fr-mt-4w">
          <SectionCard
            title={`Exploitation ${formMode === 'auto' ? 'avec' : 'sans'} raison sociale`}
            icon={formMode === FormMode.auto ? 'building-line' : 'user-line'}
            background="secondary"
          >
            {formMode === FormMode.auto ? (
              <div>
                <SearchRaisonSociale
                  value={{
                    name: exploitation.name || '',
                    nom_complet: exploitation.denominationLegale || '',
                    siret: exploitation.siret || '',
                    activite_principale: exploitation.activite || '',
                    categorie_entreprise: exploitation.formeJuridique || '',
                    siege: {
                      libelle_commune: exploitation.commune || '',
                      siret: exploitation.siret || '',
                      activite_principale: exploitation.activite || '',
                      code_postal: exploitation.postalCode || '',
                    },
                  }}
                  onChange={(value) => {
                    setExploitation((prev) => ({
                      ...prev,
                      denominationLegale: value?.nom_complet || null,
                      siret: value?.siege?.siret || null,
                      activite: value?.siege?.activite_principale || null,
                      formeJuridique: value?.categorie_entreprise || null,
                      name: value?.name?.trim() || value?.nom_complet || '',
                    }))
                  }}
                  error={error}
                />
                {exploitation?.denominationLegale && (
                  <Input
                    className="fr-mt-3w"
                    label="Libellé de l’exploitation"
                    hintText="Permet de donner un nom personnalisé à l’exploitation pour l’affichage dans l’application. Si laissé vide, le nom de la raison sociale sera utilisé."
                    nativeInputProps={{
                      placeholder: 'Entrer le nom de l’exploitation',
                      defaultValue: exploitation?.name || exploitation?.denominationLegale,
                      onChange: (e) => {
                        setExploitation('name', e.target.value)
                      },
                    }}
                  />
                )}
              </div>
            ) : (
              <div>
                <Input
                  className="fr-mt-3w"
                  label="Libellé de l’exploitation *"
                  hintText="Saisir un nom pour identifier l’exploitation"
                  nativeInputProps={{
                    placeholder: 'Entrer le nom de l’exploitation',
                    defaultValue: exploitation?.name || exploitation?.denominationLegale || '',
                    onChange: (e) => {
                      setExploitation('name', e.target.value)
                    },
                  }}
                />
              </div>
            )}
            <div className="fr-mt-3w">
              <ExploitationTagSelector
                inputValue={exploitationTagInput}
                setInputValue={setExploitationTagInput}
                options={exploitationTagsOptions}
                values={exploitation?.tags?.map((t) => t.id) || []}
                onChange={(values) => {
                  const selectedTags = exploitationTags.filter((tag) => values.includes(tag.id))
                  setExploitation('tags', selectedTags)
                }}
              />
            </div>
          </SectionCard>
          {exploitation.siret && (
            <div
              className="fr-mt-2w fr-p-2w"
              style={{
                border: `1px solid ${fr.colors.decisions.border.default.grey.default}`,
                borderRadius: '8px',
              }}
            >
              <div className="fr-mb-1w">
                <b>Dénomination : </b> {exploitation?.denominationLegale}
              </div>
              <div className="fr-mb-1w">
                <b>SIRET : </b> {exploitation?.siret}
              </div>
              <div className="fr-mb-1w">
                <b>Activité principale (NAF / APE) : </b> {exploitation?.activite}
              </div>
              <div className="fr-mb-1w">
                <b>Forme juridique : </b> {exploitation?.formeJuridique}
              </div>
            </div>
          )}
        </div>
      )}
    </>
  )
}
