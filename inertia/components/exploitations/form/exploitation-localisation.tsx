import { Alert } from '@codegouvfr/react-dsfr/Alert'

import SectionCard from '~/ui/SectionCard'
import SearchAdresse from '~/components/search-adresse'
import ExploitationMapForm from '~/components/exploitations/form/exploitation-map-form'

import type { Localisation } from '~/components/search-adresse'
import type { GeoPoint } from './exploitation-map-form'
import { ExploitationFormValues } from '~/components/exploitations/form/exploitation-form'
import { SetDataAction } from '@inertiajs/react'

export default function ExploitationLocalisation({
  exploitation,
  setExploitation,
}: {
  exploitation: ExploitationFormValues
  setExploitation: SetDataAction<ExploitationFormValues>
}) {
  let exploitationLocalisation: Localisation | null = null
  let geometry: GeoPoint | undefined = undefined

  if (
    exploitation?.location &&
    Number.isFinite(exploitation?.location?.x) &&
    Number.isFinite(exploitation?.location?.y)
  ) {
    geometry = {
      type: 'Point',
      coordinates: [exploitation.location.x, exploitation.location.y],
    }

    exploitationLocalisation = {
      type: 'Feature',
      geometry,
      properties: {
        name: '',
        label: [
          exploitation.addressLine1,
          exploitation.addressLine2,
          exploitation.postalCode,
          exploitation.commune,
        ]
          .filter(Boolean)
          .join(', '),
        postcode: exploitation.postalCode || '',
        city: exploitation.commune || '',
      },
    }
  }

  return (
    <div>
      <SectionCard title="Adresse" icon="fr-icon-map-pin-2-line" background="secondary">
        <Alert
          description="Optionnel, mais recommandé : Entrer une adresse ou placer un point pour localiser votre exploitation."
          severity="info"
          small
        />
        <div className="fr-mt-4w">
          <SearchAdresse
            value={exploitationLocalisation}
            onChange={(value) => {
              setExploitation((prev) => ({
                ...prev,
                addressLine1: value.properties.name || null,
                postalCode: value.properties.postcode || null,
                commune: value.properties.city || null,
                location: { x: value.geometry.coordinates[0], y: value.geometry.coordinates[1] },
              }))
            }}
          />
          <div className="fr-mt-4w text-center">
            <b>Ou positionnez l’exploitation directement sur la carte</b>
          </div>
          <div className="fr-mt-4w" style={{ height: '600px', marginBottom: '2rem' }}>
            <ExploitationMapForm
              geometry={geometry}
              setGeometry={(geo) => {
                setExploitation('location', { x: geo.coordinates[0], y: geo.coordinates[1] })
              }}
            />
          </div>
        </div>
      </SectionCard>
    </div>
  )
}
