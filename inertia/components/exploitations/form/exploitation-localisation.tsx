import { useEffect, useState } from 'react'
import { Alert } from '@codegouvfr/react-dsfr/Alert'

import SectionCard from '~/ui/SectionCard'
import SearchAdresse from '~/components/search-adresse'
import ExploitationMapForm from '~/components/exploitations/form/exploitation-map-form'
import { getAddressFromCoords } from '~/lib/communes'

import type { Localisation } from '~/components/search-adresse'
import type { GeoPoint } from './exploitation-map-form'

export default function ExploitationLocalisation({
  exploitationLocalisation,
  setExploitationLocalisation,
}: {
  exploitationLocalisation: Localisation | null
  setExploitationLocalisation: (value: Localisation | null) => void
}) {
  const [geometry, setGeometry] = useState<GeoPoint | undefined>(
    exploitationLocalisation?.geometry
      ? {
          type: 'Point' as const,
          coordinates: (exploitationLocalisation.geometry as GeoPoint).coordinates,
        }
      : undefined
  )

  useEffect(() => {
    if (exploitationLocalisation?.geometry) {
      setGeometry(exploitationLocalisation.geometry as GeoPoint)
    }
  }, [exploitationLocalisation])

  useEffect(() => {
    const updateLocalisationFromGeometry = async () => {
      if (geometry &&
          (!exploitationLocalisation?.geometry ||
           exploitationLocalisation.geometry.coordinates[0] !== geometry.coordinates[0] ||
           exploitationLocalisation.geometry.coordinates[1] !== geometry.coordinates[1])) {
        const [lon, lat] = geometry.coordinates
        const localisation = await getAddressFromCoords({ lat, lon })

        setExploitationLocalisation({
          type: 'Feature',
          geometry,
          properties: localisation?.properties || { label: 'Pas d’adresse pour cette position' },
        } as Localisation)
      }
    }

    updateLocalisationFromGeometry()
  }, [geometry, setExploitationLocalisation])

  return (
    <div>
      <SectionCard title="Adresse" icon="fr-icon-map-pin-2-line" background="secondary">
        <Alert
          description="Optionnel, mais recommandé : Entrer une adresse ou placer un point pour localiser votre exploitation."
          severity="info"
          small
        />
        <div className="fr-mt-4w">
          <SearchAdresse
            value={exploitationLocalisation}
            onChange={(value) => {
              setExploitationLocalisation(value)
              if (value?.geometry) {
                setGeometry(value.geometry as GeoPoint)
              }
            }}
          />
          <div className="fr-mt-4w text-center">
            <b>Ou positionnez l’exploitation directement sur la carte</b>
          </div>
          <div className="fr-mt-4w" style={{ height: '600px', marginBottom: '2rem' }}>
            <ExploitationMapForm geometry={geometry} setGeometry={setGeometry} />
          </div>
        </div>
      </SectionCard>
    </div>
  )
}
