import { useEffect, useRef, useState } from 'react'
import Select from '@codegouvfr/react-dsfr/SelectNext'
import maplibre, { type LngLatLike, type MapMouseEvent, type GeoJSONSource } from 'maplibre-gl'

import 'maplibre-gl/dist/maplibre-gl.css'
import photo from '~/components/map/styles/photo.json'
import planIGN from '~/components/map/styles/plan-ign.json'
import vector from '~/components/map/styles/vector.json'

export type GeoPoint = {
  type: 'Point'
  coordinates: [number, number]
}

type MiniMapFormProps = {
  geometry?: GeoPoint
  setGeometry: (geometry: GeoPoint) => void
}

type StylesMap = {
  [key: string]: any
}

const stylesMap: StylesMap = {
  'plan-ign': planIGN,
  'orthophoto': photo,
  'vector': vector,
}

export default function MiniMapForm({ geometry, setGeometry }: MiniMapFormProps) {
  const mapContainerRef = useRef<HTMLDivElement | null>(null)
  const mapRef = useRef<maplibre.Map | null>(null)
  const currentStyleRef = useRef<string>('plan-ign')
  const [style, setStyle] = useState<string>(currentStyleRef.current)
  const geojson = useRef<GeoJSON.FeatureCollection<GeoJSON.Point>>({
    type: 'FeatureCollection',
    features: [
      {
        type: 'Feature',
        geometry: geometry
          ? { ...geometry }
          : {
              type: 'Point',
              coordinates: [2.24, 46.54],
            },
        properties: {},
      },
    ],
  })

  useEffect(() => {
    if (!mapContainerRef.current) {
      return
    }

    const map = new maplibre.Map({
      container: mapContainerRef.current,
      style: stylesMap[style],
      center: geometry ? (geometry.coordinates as LngLatLike) : [2.24, 46.54],
      zoom: geometry ? 12 : 5,
      attributionControl: { compact: true },
    })

    const canvas = map.getCanvasContainer()
    mapRef.current = map

    const onMove = (e: MapMouseEvent) => {
      const coords = e.lngLat
      canvas.style.cursor = 'grabbing'
      geojson.current.features[0].geometry.coordinates = [coords.lng, coords.lat]
      const source = map.getSource('point') as GeoJSONSource
      source?.setData(geojson.current)
    }

    map.on('load', () => {
      map.addSource('point', {
        type: 'geojson',
        data: geojson.current,
      })

      map.addLayer({
        id: 'point',
        type: 'circle',
        source: 'point',
        paint: {
          'circle-radius': 10,
          'circle-color': '#007cbf',
          'circle-stroke-width': 2,
          'circle-stroke-color': 'white',
        },
      })

      map.on('mouseenter', 'point', () => {
        map.setPaintProperty('point', 'circle-color', '#000091')
        canvas.style.cursor = 'move'
      })

      map.on('mouseleave', 'point', () => {
        map.setPaintProperty('point', 'circle-color', '#007cbf')
        canvas.style.cursor = ''
      })

      map.on('click', (e: MapMouseEvent) => {
        const newCoords: [number, number] = [e.lngLat.lng, e.lngLat.lat]
        geojson.current.features[0].geometry.coordinates = newCoords
        const source = map.getSource('point') as GeoJSONSource
        source?.setData(geojson.current)
        setGeometry({
          type: 'Point',
          coordinates: newCoords,
        })
      })

      map.on('mousedown', 'point', (e: MapMouseEvent) => {
        e.preventDefault()
        canvas.style.cursor = 'grab'
        map.on('mousemove', onMove)
        map.once('mouseup', () => {
          setGeometry(geojson.current.features[0].geometry as GeoPoint)
          map.off('mousemove', onMove)
        })
      })
    })

    return () => {
      map.remove()
    }
  }, [])

  // Mise à jour du style de la carte
  useEffect(() => {
    const map = mapRef.current
    if (map && style !== currentStyleRef.current) {
      const center = map.getCenter()
      const zoom = map.getZoom()

      map.setStyle(stylesMap[style])

      map.once('styledata', () => {
        map.setCenter(center)
        map.setZoom(zoom)

        const source = map.getSource('point') as GeoJSONSource

        if (source) {
          source.setData(geojson.current)
        } else {
          map.addSource('point', {
            type: 'geojson',
            data: geojson.current,
          })

          map.addLayer({
            id: 'point',
            type: 'circle',
            source: 'point',
            paint: {
              'circle-radius': 10,
              'circle-color': '#007cbf',
              'circle-stroke-width': 2,
              'circle-stroke-color': 'white',
            },
          })
        }
      })

      currentStyleRef.current = style
    }
  }, [style])

  // Mets à jour la carte lorsqu'une adresse est sélectionnée dans SearchAdresse
  useEffect(() => {
    const map = mapRef.current
    if (map && geometry) {
      geojson.current.features[0].geometry.coordinates = geometry.coordinates
      const source = map.getSource('point') as GeoJSONSource
      if (source) {
        source.setData(geojson.current)
        map.flyTo({
          center: geometry.coordinates as LngLatLike,
          zoom: 14,
        })
      }
    }
  }, [geometry])

  return (
    <div className="flex flex-col h-full w-full relative border">
      <div ref={mapContainerRef} className="flex h-full w-full" />
      <Select
        label=""
        style={{ position: 'absolute' }}
        nativeSelectProps={{
          defaultValue: 'plan-ign',
          onChange: (e) => setStyle(e.target.value),
        }}
        options={[
          { value: 'plan-ign', label: 'Plan IGN' },
          { value: 'orthophoto', label: 'Photographie aérienne' },
          { value: 'vector', label: 'Carte vectorielle' },
        ]}
      />
    </div>
  )
}
