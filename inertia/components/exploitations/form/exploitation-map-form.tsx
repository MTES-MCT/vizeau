import { useEffect, useRef, useState } from 'react'
import { fr } from '@codegouvfr/react-dsfr'
import Select from '@codegouvfr/react-dsfr/SelectNext'
import maplibre, { type LngLatLike, type MapMouseEvent } from 'maplibre-gl'

import 'maplibre-gl/dist/maplibre-gl.css'
import photo from '~/components/map/styles/photo.json'
import planIGN from '~/components/map/styles/plan-ign.json'
import vector from '~/components/map/styles/vector.json'

export type GeoPoint = {
  type: 'Point'
  coordinates: [number, number]
}

type MiniMapFormProps = {
  geometry?: GeoPoint
  setGeometry: (geometry: GeoPoint) => void
}

type StylesMap = {
  [key: string]: any
}

const stylesMap: StylesMap = {
  'plan-ign': planIGN,
  'orthophoto': photo,
  'vector': vector,
}

export default function MiniMapForm({ geometry, setGeometry }: MiniMapFormProps) {
  const mapContainerRef = useRef<HTMLDivElement | null>(null)
  const mapRef = useRef<maplibre.Map | null>(null)
  const markerRef = useRef<maplibre.Marker | null>(null)
  const currentStyleRef = useRef<string>('plan-ign')
  const [style, setStyle] = useState<string>(currentStyleRef.current)
  const markerColor = fr.colors.decisions.artwork.major.blueFrance.default

  useEffect(() => {
    if (!mapContainerRef.current) {
      return
    }

    const map = new maplibre.Map({
      container: mapContainerRef.current,
      style: stylesMap[style],
      center: geometry ? (geometry.coordinates as LngLatLike) : [2.24, 46.54],
      zoom: geometry ? 16 : 5,
      maxZoom: 17.5,
      attributionControl: { compact: true },
    })

    mapRef.current = map

    map.on('load', () => {

      const marker = new maplibre.Marker({
        draggable: false,
        color: markerColor,
      })
        .setLngLat(geometry ? (geometry.coordinates as LngLatLike) : [2.24, 46.54])
        .addTo(map)

      markerRef.current = marker

      // Déplacer le marker lors d'un clic sur la carte
      map.on('click', (e: MapMouseEvent) => {
        const newCoords: [number, number] = [e.lngLat.lng, e.lngLat.lat]
        marker.setLngLat(newCoords)
        setGeometry({
          type: 'Point',
          coordinates: newCoords,
        })
      })
    })

    return () => {
      map.remove()
    }
  }, [])

  // Mise à jour du style de la carte
  useEffect(() => {
    const map = mapRef.current
    const marker = markerRef.current
    if (map && style !== currentStyleRef.current) {
      const center = map.getCenter()
      const zoom = map.getZoom()

      map.setStyle(stylesMap[style])

      map.once('styledata', () => {
        map.setCenter(center)
        map.setZoom(zoom)

        // Remettre le marker après le changement de style
        if (marker) {
          marker.addTo(map)
        }
      })

      currentStyleRef.current = style
    }
  }, [style])

  // Mets à jour la carte lorsqu'une adresse est sélectionnée dans SearchAdresse
  useEffect(() => {
    const map = mapRef.current
    const marker = markerRef.current
    if (map && marker && geometry) {
      marker.setLngLat(geometry.coordinates as LngLatLike)
      map.flyTo({
        center: geometry.coordinates as LngLatLike,
        zoom: 16,
      })
    }
  }, [geometry])

  return (
    <div className="flex flex-col h-full w-full relative border">
      <div ref={mapContainerRef} className="flex h-full w-full" />
      <Select
        label=""
        style={{ position: 'absolute' }}
        nativeSelectProps={{
          defaultValue: 'plan-ign',
          onChange: (e) => setStyle(e.target.value),
        }}
        options={[
          { value: 'plan-ign', label: 'Plan IGN' },
          { value: 'orthophoto', label: 'Photographie aérienne' },
          { value: 'vector', label: 'Carte vectorielle' },
        ]}
      />
    </div>
  )
}
