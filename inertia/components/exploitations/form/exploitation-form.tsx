import { useState } from 'react'
import { Button } from '@codegouvfr/react-dsfr/Button'
import { Stepper } from '@codegouvfr/react-dsfr/Stepper'
import ExploitationIdentification from '~/components/exploitations/form/exploitation-identification'
import type { ContactJson, ExploitationJson } from '../../../../types/models'
import type { Company } from '~/components/search-raison-sociale'
import type { Localisation } from '~/components/search-adresse'
import ExploitationLocalisation from './exploitation-localisation'
import ExploitationContact from './exploitation-contact'

const steps = ['Type d’exploitation', 'Localisation', 'Contact']

interface ExploitationsFormProps {
  step: number
  setStep: (step: number) => void
  exploitation: ExploitationJson | null
  setExploitation: (exploitation: ExploitationJson | null) => void
}

export default function ExploitationsForm({
  step,
  setStep,
  exploitation,
  setExploitation,
}: ExploitationsFormProps) {
  const [exploitationIdentification, setExploitationIdentification] = useState<
    (Company & { name?: string }) | null
  >(null)
  const [exploitationLocalisation, setExploitationLocalisation] = useState<Localisation | null>(
    null
  )
  const [exploitationContact, setExploitationContact] = useState<ContactJson | null>()

  const isNextStepDisabled = step === 1 && !exploitationIdentification

  function handleSteps() {
    if (step === 1) {
      setExploitation({
        ...exploitation,
        denominationLegale: exploitationIdentification?.nom_complet || null,
        siren: exploitationIdentification?.siren || null,
        siret: exploitationIdentification?.siege?.siret || null,
        activite: exploitationIdentification?.siege?.activite_principale || null,
        formeJuridique: exploitationIdentification?.categorie_entreprise || null,
        name:
          exploitationIdentification?.name.trim() || exploitationIdentification?.nom_complet || '',
      } as ExploitationJson)
    }

    if (step === 2) {
      setExploitation({
        ...exploitation,
        addressLine1: exploitationLocalisation?.properties.name || null,
        postalCode: exploitationLocalisation?.properties.postcode || null,
        commune: exploitationLocalisation?.properties.city || null,
        location: {
          x: exploitationLocalisation?.geometry?.coordinates[0],
          y: exploitationLocalisation?.geometry?.coordinates[1],
        },
      } as ExploitationJson)
    }

    if (step === 3) {
      if (!exploitation) return

      setExploitation({
        ...exploitation,
        contacts: exploitationContact ? [exploitationContact] : [],
      })
    }

    if (step !== 3) {
      setStep(step + 1)
    }
  }

  return (
    <div className="fr-container fr-mt-4w">
      <Stepper
        title={steps[step - 1]}
        currentStep={step}
        stepCount={steps.length}
        nextTitle={steps[step]}
      />
      {step === 1 && (
        <ExploitationIdentification
          exploitationIdentification={exploitationIdentification}
          setExploitationIdentification={setExploitationIdentification}
        />
      )}
      {step === 2 && (
        <ExploitationLocalisation
          exploitationLocalisation={exploitationLocalisation}
          setExploitationLocalisation={setExploitationLocalisation}
        />
      )}
      {step === 3 && (
        <ExploitationContact
          exploitationContact={exploitationContact}
          setExploitationContact={setExploitationContact}
        />
      )}
      <div className="fr-mb-2w fr-mt-4w float-right">
        {step > 1 && (
          <Button
            priority="secondary"
            className="fr-mt-2w fr-mr-2w"
            iconId="fr-icon-arrow-left-line"
            onClick={() => setStep(step - 1)}
          >
            Étape précédente
          </Button>
        )}
        <Button
          className="fr-mt-2w"
          iconId="fr-icon-arrow-right-line"
          disabled={isNextStepDisabled}
          onClick={handleSteps}
        >
          {step === 3 ? 'Créer l’exploitation' : 'Étape suivante'}
        </Button>
      </div>
    </div>
  )
}
