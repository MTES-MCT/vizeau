import { useState } from 'react'
import { Button } from '@codegouvfr/react-dsfr/Button'
import { Stepper } from '@codegouvfr/react-dsfr/Stepper'

import ExploitationIdentification from '~/components/exploitations/form/exploitation-identification'
import ExploitationLocalisation from '~/components/exploitations/form/exploitation-localisation'
import ExploitationContact from '~/components/exploitations/form/exploitation-contact'
import { checkSiretExists } from '~/lib/exploitations'

import type { ExploitationJson } from '../../../../types/models'
import type { RaisonSociale } from '~/components/search-raison-sociale'
import type { Localisation } from '~/components/search-adresse'

interface ExploitationsFormProps {
  step: number
  setStep: (step: number) => void
  exploitation: ExploitationJson | null
  setExploitation: (exploitation: ExploitationJson | null) => void
  error?: { [key: string]: any }
  setError?: (value: { [key: string]: any }) => void
  onSubmit: (exploitation: ExploitationJson) => void
  isEdition?: boolean
}

export interface ExploitationContact {
  firstName: string
  lastName: string
  role: string
  email: string
  phoneNumber: string
}

const steps = ['Type d’exploitation', 'Localisation', 'Contact']

export default function ExploitationsForm({
  step,
  setStep,
  exploitation,
  setExploitation,
  error,
  setError,
  onSubmit,
  isEdition = false,
}: ExploitationsFormProps) {
  const [exploitationIdentification, setExploitationIdentification] = useState<
    | (RaisonSociale & {
        name?: string
        siret?: string
        activite_principale?: string
        categorie_entreprise?: string
      })
    | null
  >(
    exploitation
      ? {
          nom_complet: exploitation.denominationLegale || exploitation.name,
          siret: exploitation.siret || '',
          categorie_entreprise: exploitation.formeJuridique || '',
          activite_principale: exploitation.activite || '',
          siege: {
            code_postal: exploitation.postalCode || '',
            libelle_commune: exploitation.commune || '',
            siret: exploitation.siret || '',
            activite_principale: exploitation.activite || '',
          },
          name: exploitation.name,
        }
      : null
  )
  const [exploitationLocalisation, setExploitationLocalisation] = useState<Localisation | null>(
    () => {
      if (exploitation?.location) {
        const address = [
          exploitation.addressLine1,
          exploitation.addressLine2,
          exploitation.postalCode,
          exploitation.commune,
        ]
          .filter(Boolean)
          .join(', ')

        return {
          type: 'Feature',
          geometry: {
            type: 'Point' as const,
            coordinates: [exploitation.location.x, exploitation.location.y],
          },
          properties: {
            label: address,
            postcode: exploitation.postalCode,
            city: exploitation.commune,
          },
        } as Localisation
      }
      return null
    }
  )
  const [exploitationContact, setExploitationContact] = useState<ExploitationContact | null>(() => {
    if (exploitation?.contacts && exploitation.contacts.length > 0) {
      const contact = exploitation.contacts[0]
      return {
        firstName: contact.firstName || '',
        lastName: contact.lastName || '',
        role: contact.role || '',
        email: contact.email || '',
        phoneNumber: contact.phoneNumber || '',
        error: null,
      }
    }
    return null
  })

  const isNextStepDisabled = step === 1 && !exploitationIdentification

  async function handleSteps() {
    if (step === 1) {
      if (exploitationIdentification?.siege?.siret) {
        const shouldCheckSiret =
          !isEdition || exploitationIdentification.siege.siret !== exploitation?.siret

        if (shouldCheckSiret) {
          const isSiretUsed = await checkSiretExists(exploitationIdentification?.siege?.siret)

          if (isSiretUsed) {
            setError?.({ siret: true })
            return
          }
        }
      }

      setError?.({})

      setExploitation({
        ...exploitation,
        denominationLegale: exploitationIdentification?.nom_complet || null,
        siret: exploitationIdentification?.siege?.siret || null,
        activite: exploitationIdentification?.siege?.activite_principale || null,
        formeJuridique: exploitationIdentification?.categorie_entreprise || null,
        name:
          exploitationIdentification?.name?.trim() || exploitationIdentification?.nom_complet || '',
      } as ExploitationJson)
    }

    if (step === 2) {
      setExploitation({
        ...exploitation,
        addressLine1: exploitationLocalisation?.properties.name || null,
        postalCode: exploitationLocalisation?.properties.postcode || null,
        commune: exploitationLocalisation?.properties.city || null,
        longitude: exploitationLocalisation?.geometry?.coordinates[0],
        latitude: exploitationLocalisation?.geometry?.coordinates[1],
      } as ExploitationJson)
    }

    if (step === 3) {
      if (!exploitation) {
        return
      }

      const updatedExploitation = {
        ...exploitation,
        contactFirstName: exploitationContact?.firstName || null,
        contactLastName: exploitationContact?.lastName || null,
        contactRole: exploitationContact?.role || null,
        contactEmail: exploitationContact?.email || null,
        contactPhoneNumber: exploitationContact?.phoneNumber || null,
      }

      setExploitation(updatedExploitation)
      onSubmit(updatedExploitation)
    }

    if (step !== 3) {
      setStep(step + 1)
    }
  }

  return (
    <div className="fr-container fr-mt-4w">
      <Stepper
        title={steps[step - 1]}
        currentStep={step}
        stepCount={steps.length}
        nextTitle={steps[step]}
      />
      {step === 1 && (
        <ExploitationIdentification
          exploitationIdentification={exploitationIdentification}
          setExploitationIdentification={setExploitationIdentification}
          error={
            error?.siret && {
              ...error,
              message: 'Ce SIRET est déjà associé à une exploitation existante.',
            }
          }
          setError={setError}
        />
      )}
      {step === 2 && (
        <ExploitationLocalisation
          exploitationLocalisation={exploitationLocalisation}
          setExploitationLocalisation={setExploitationLocalisation}
        />
      )}
      {step === 3 && (
        <ExploitationContact
          exploitationContact={exploitationContact}
          setExploitationContact={setExploitationContact}
          error={error}
          setError={setError}
        />
      )}
      <div className="fr-mb-2w fr-mt-4w float-right">
        {step > 1 && (
          <Button
            priority="secondary"
            className="fr-mt-2w fr-mr-2w"
            iconId="fr-icon-arrow-left-line"
            onClick={() => setStep(step - 1)}
          >
            Étape précédente
          </Button>
        )}
        <Button
          className="fr-mt-2w"
          iconId="fr-icon-arrow-right-line"
          disabled={isNextStepDisabled}
          onClick={handleSteps}
        >
          {step === 3
            ? isEdition
              ? 'Valider les modifications'
              : 'Créer l’exploitation'
            : 'Étape suivante'}
        </Button>
      </div>
    </div>
  )
}
