import { Button } from '@codegouvfr/react-dsfr/Button'
import { Stepper } from '@codegouvfr/react-dsfr/Stepper'

import ExploitationIdentification from '~/components/exploitations/form/exploitation-identification'
import ExploitationLocalisation from '~/components/exploitations/form/exploitation-localisation'
import ExploitationContact from '~/components/exploitations/form/exploitation-contact'
import { checkSiretExists } from '~/lib/exploitations'

import type { ContactJson, ExploitationJson, ExploitationTagJson } from '../../../../types/models'
import { SetDataAction } from '@inertiajs/react'

interface ExploitationsFormProps {
  step: number
  visitStep: (step: number) => void
  initialExploitation?: ExploitationJson
  exploitation: ExploitationFormValues
  setExploitation: SetDataAction<ExploitationFormValues>
  error?: { [key: string]: any }
  setError?: (value: { [key: string]: any }) => void
  onSubmit: () => void
  exploitationTags: ExploitationTagJson[]
  isEdition?: boolean
}

export type ExploitationFormValues = {
  id?: string
  name: string
  formeJuridique: string | null
  siret: string | null
  denominationLegale: string | null
  activite: string | null
  addressLine1: string | null
  addressLine2: string | null
  postalCode: string | null
  postalBox: string | null
  commune: string | null
  location: { x: number; y: number } | null
  notes: string | null
  contacts: ContactJson[]
  tags: ExploitationTagJson[]
}

// Function to get default values for the exploitation form. Can take an optional exploitation to prefill the form, in edition mode.
export function getExploitationFormDefaultValues(
  exploitation?: Partial<ExploitationJson> | null
): ExploitationFormValues {
  return {
    id: exploitation?.id,
    name: exploitation?.name || '',
    formeJuridique: exploitation?.formeJuridique || null,
    siret: exploitation?.siret || null,
    denominationLegale: exploitation?.denominationLegale || null,
    activite: exploitation?.activite || null,
    addressLine1: exploitation?.addressLine1 || null,
    addressLine2: exploitation?.addressLine2 || null,
    postalCode: exploitation?.postalCode || null,
    postalBox: exploitation?.postalBox || null,
    commune: exploitation?.commune || null,
    location: exploitation?.location || null,
    notes: exploitation?.notes || null,
    contacts: exploitation?.contacts || [],
    tags: exploitation?.tags || [],
  }
}

const steps = ['Type d’exploitation', 'Localisation', 'Contact']

export default function ExploitationsForm({
  step,
  visitStep,
  initialExploitation,
  exploitation,
  setExploitation,
  error,
  setError,
  onSubmit,
  exploitationTags,
  isEdition = false,
}: ExploitationsFormProps) {
  // Name is the only required field, so we can enable the next button as soon as it's filled
  const isNextStepDisabled = step === 1 && !exploitation.name

  async function handleSteps() {
    if (step === 1) {
      if (exploitation?.siret) {
        const shouldCheckSiret = !isEdition || initialExploitation?.siret !== exploitation?.siret

        if (shouldCheckSiret) {
          const isSiretUsed = await checkSiretExists(exploitation.siret)

          if (isSiretUsed) {
            setError?.({ siret: true })
            return
          }
        }
      }

      setError?.({})
    }

    if (step === 3) {
      onSubmit()
    }

    if (step !== 3) {
      visitStep(step + 1)
    }
  }

  return (
    <div className="fr-container fr-mt-4w">
      <Stepper
        title={steps[step - 1]}
        currentStep={step}
        stepCount={steps.length}
        nextTitle={steps[step]}
      />
      {step === 1 && (
        <ExploitationIdentification
          exploitation={exploitation}
          setExploitation={setExploitation}
          error={
            error?.siret && {
              ...error,
              message: 'Ce SIRET est déjà associé à une exploitation existante.',
            }
          }
          exploitationTags={exploitationTags}
        />
      )}
      {step === 2 && (
        <ExploitationLocalisation exploitation={exploitation} setExploitation={setExploitation} />
      )}
      {step === 3 && (
        <ExploitationContact
          exploitation={exploitation}
          setExploitation={setExploitation}
          error={error}
          setError={setError}
        />
      )}
      <div className="fr-mb-2w fr-mt-4w float-right">
        {step > 1 && (
          <Button
            priority="secondary"
            className="fr-mt-2w fr-mr-2w"
            iconId="fr-icon-arrow-left-line"
            onClick={() => visitStep(step - 1)}
          >
            Étape précédente
          </Button>
        )}
        <Button
          className="fr-mt-2w"
          iconId="fr-icon-arrow-right-line"
          disabled={isNextStepDisabled}
          onClick={handleSteps}
        >
          {step === 3
            ? isEdition
              ? 'Valider les modifications'
              : 'Créer l’exploitation'
            : 'Étape suivante'}
        </Button>
      </div>
    </div>
  )
}
