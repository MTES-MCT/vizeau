import { useState } from 'react'
import { Table } from '@codegouvfr/react-dsfr/Table'
import { ExploitationJson } from '../../../types/models'
import { displayContactName } from '~/functions/contacts'
import { Link } from '@inertiajs/react'
import { ComponentProps } from 'react'
import Checkbox from '@codegouvfr/react-dsfr/Checkbox'

function TableLinkCell({ children, ...props }: ComponentProps<typeof Link>) {
  return (
    <Link className="block bg-none! p-4!" tabIndex={0} {...props}>
      {children}
    </Link>
  )
}

const tableElements = [
  {
    Organisation: {
      name: 'organisation',
      icon: 'fr-icon-map-pin-user-line',
    },
  },
  {
    Utilisateur: {
      name: 'utilisateur',
      icon: 'fr-icon-user-line',
    },
  },
  {
    Email: {
      name: 'email',
      icon: 'fr-icon-mail-line',
    },
  },
  {
    Téléphone: {
      name: 'telephone',
      icon: 'fr-icon-phone-line',
    },
  },
  {
    Localisation: {
      name: 'localisation',
      icon: 'fr-icon-map-pin-2-line',
    },
  },
]

export default function ExploitationsTable({
  exploitations = [],
  showFilter = false,
}: {
  exploitations?: ExploitationJson[]
  showFilter?: boolean
}) {
  const [visibleColumns, setVisibleColumns] = useState<Set<string>>(
    new Set(tableElements.map((element) => Object.values(element)[0].name))
  )

  const handleColumnToggle = (columnName: string) => {
    setVisibleColumns((prev) => {
      const newSet = new Set(prev)

      if (newSet.has(columnName)) {
        newSet.delete(columnName)
      } else {
        newSet.add(columnName)
      }

      return newSet
    })
  }

  const visibleTableElements = tableElements.filter((element) =>
    visibleColumns.has(Object.values(element)[0].name)
  )

  return (
    exploitations.length > 0 && (
      <>
        {showFilter && (
          <div className="flex justify-end">
            <div className="border fr-p-2w rounded-lg">
              <Checkbox
                legend="Filtrer les colonnes"
                options={tableElements.map((element) => {
                  const [label, config] = Object.entries(element)[0]
                  return {
                    label,
                    nativeInputProps: {
                      name: config.name,
                      checked: visibleColumns.has(config.name),
                      onChange: () => handleColumnToggle(config.name),
                    },
                  }
                })}
                orientation="horizontal"
                small
              />
            </div>
          </div>
        )}
        <Table
          bordered
          fixed
          className="[&_td]:p-0!"
          headers={visibleTableElements.map((element) => {
            const [label, config] = Object.entries(element)[0]
            return (
              <div key={config.name}>
                <span className={`${config.icon} fr-icon--sm`} /> {label}
              </div>
            )
          })}
          data={exploitations.map((exploitation) => {
            const LinkCell = ({ children }: ComponentProps<typeof Link>) => (
              <TableLinkCell
                href={`/exploitations/${exploitation.id}`}
                aria-label={`Voir les détails de l'exploitation ${exploitation.name}`}
              >
                {children}
              </TableLinkCell>
            )

            const allColumns = [
              [<LinkCell key="organisation">{exploitation.name}</LinkCell>],
              [
                <LinkCell key="utilisateur">
                  {displayContactName(exploitation?.contacts?.[0])}
                </LinkCell>,
              ],
              [<LinkCell key="email">{exploitation.contacts?.[0]?.email || 'N/A'}</LinkCell>],
              [
                <LinkCell key="telephone">
                  {exploitation.contacts?.[0]?.phoneNumber || 'N/A'}
                </LinkCell>,
              ],
              [<LinkCell key="localisation">{exploitation.commune || 'N/A'}</LinkCell>],
            ]

            return allColumns.filter((_, index) =>
              visibleColumns.has(
                tableElements[index] && Object.values(tableElements[index])[0].name
              )
            )
          })}
        />
      </>
    )
  )
}
