import { useState } from 'react'
import { usePage, router } from '@inertiajs/react'
import { InferPageProps } from '@adonisjs/inertia/types'
import cultures from '../../../database/data/cultures.json'
import ListItem from '~/ui/ListItem'
import { ParcelleJson } from '../../../types/models'
import { createModal } from '@codegouvfr/react-dsfr/Modal'
import CommentFormModal from '../parcelle/comment-form-modal'
import ExploitationsController from '#controllers/exploitations_controller'
import { FlashMessages } from '../flash-message'

export type ExploitationParcellesListProps = {
  parcelles: ParcelleJson[]
  exploitationId: string
  reloadProp?: string
}

const handleCommentModal = createModal({
  id: 'add-comment-modal',
  isOpenedByDefault: false,
})

export default function ExploitationParcellesList({
  parcelles,
  exploitationId,
  reloadProp = 'exploitation',
}: ExploitationParcellesListProps) {
  const { flashMessages } = usePage<InferPageProps<ExploitationsController, 'get'>>().props
  const [selectedParcelle, setSelectedParcelle] = useState<ParcelleJson | null>(null)

  const handleDetachParcelle = (rpgId: string, year: number) => {
    router.delete(`/exploitations/${exploitationId}/parcelles/${rpgId}/detach`, {
      data: { year },
      preserveScroll: true,
      only: [reloadProp],
    })
  }

  return (
    <div className="flex flex-col gap-4">
      <FlashMessages flashMessages={flashMessages} />
      {parcelles.map((parcelle) => (
        <ListItem
          key={`${parcelle.rpgId}-${parcelle.year}`}
          hasBorder
          variant="compact"
          title={`Parcelle RPG ${parcelle.rpgId}`}
          href={`/visualisation?exploitationId=${exploitationId}&parcelleId=${parcelle.rpgId}&millesime=${parcelle.year}`}
          actions={[
            {
              label: parcelle.comment ? 'Modifier le commentaire' : 'Ajouter un commentaire',
              iconId: parcelle.comment ? 'fr-icon-edit-line' : 'fr-icon-add-line',
              onClick: () => {
                setSelectedParcelle(parcelle)
                handleCommentModal.open()
              },
            },
            {
              label: 'DÃ©tacher la parcelle',
              onClick: () => handleDetachParcelle(parcelle.rpgId, parcelle.year),
              iconId: 'fr-icon-link-unlink',
              isCritical: true,
            },
          ]}
          tags={[
            {
              label:
                cultures.find((culture) => culture.code === parcelle.cultureCode)?.label ||
                'Culture inconnue',
            },
          ]}
          metas={[
            { content: `${parcelle?.surface || 'N/A'} ha`, iconId: 'fr-icon-ruler-line' },
            { content: parcelle.year.toString(), iconId: 'fr-icon-calendar-line' },
            {
              content: parcelle.comment && 'Commentaire',
              iconId: parcelle.comment && 'fr-icon-draft-line',
            },
          ]}
        />
      ))}
      <CommentFormModal
        parcelle={selectedParcelle}
        exploitationId={exploitationId}
        handleCommentModal={handleCommentModal}
      />
    </div>
  )
}
