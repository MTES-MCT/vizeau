import { ChangeEvent, useState } from 'react'
import { Head, router } from '@inertiajs/react'

import { fr } from '@codegouvfr/react-dsfr'
import { Button } from '@codegouvfr/react-dsfr/Button'
import { SearchBar } from '@codegouvfr/react-dsfr/SearchBar'

import Layout from '~/ui/layouts/layout'
import { downloadCsv } from '~/lib/export_csv'
import ExploitationsList from '~/components/exploitations/exploitations-list'
import ExploitationsTable from '~/components/exploitations/exploitations-table'
import { debounce } from 'lodash-es'
import { InferPageProps } from '@adonisjs/inertia/types'
import ExploitationsController from '#controllers/exploitations_controller'

const handleSearch = debounce((e: ChangeEvent<HTMLInputElement>) => {
  router.reload({
    only: ['exploitationsWithPagination'],
    data: { recherche: e.target.value },
    replace: true,
  })
}, 300)

export default function Exploitations({
  exploitationsWithPagination,
  exploitationCount,
  queryString,
}: InferPageProps<ExploitationsController, 'index'>) {
  const { data: exploitations } = exploitationsWithPagination
  const [isList, setIsList] = useState(true)
  const [showFilter, setShowFilter] = useState(false)

  return (
    <Layout>
      <Head title="Exploitations" />
      <div
        className="fr-p-2w"
        style={{ backgroundColor: fr.colors.decisions.background.alt.blueFrance.default }}
      >
        <div className="fr-container flex justify-between items-center">
          <div>
            <div className="fr-h6 fr-mb-0">Liste des exploitations</div>
          </div>
          {exploitationCount > 0 && (
            <div className="flex items-center">
              <Button iconId="fr-icon-add-line" linkProps={{ href: '/exploitations/creation' }}>
                Ajouter une exploitation
              </Button>
            </div>
          )}
        </div>
      </div>

      <div className="fr-container fr-mt-4w fr-mb-4w flex flex-col flex-1">
        {exploitationCount > 0 && (
          <div className="w-full flex justify-between fr-mb-4w">
            <SearchBar
              className="flex flex-1 fr-mr-2w"
              renderInput={({ className, id, placeholder, type }) => (
                <input
                  className={className}
                  id={id}
                  placeholder={placeholder}
                  type={type}
                  onChange={handleSearch}
                  defaultValue={queryString?.recherche || ''}
                />
              )}
            />
            <div className="flex items-center flex-1">
              {exploitations.length > 0 && (
                <div className="flex items-center gap-3 flex-1">
                  <Button
                    priority="secondary"
                    iconId="fr-icon-download-line"
                    title="Télécharger"
                    onClick={() => downloadCsv(exploitations, 'exploitations-export.csv')}
                  />
                  {!isList && (
                    <Button
                      priority={showFilter ? 'secondary' : 'tertiary'}
                      iconId="fr-icon-settings-5-line"
                      onClick={() => setShowFilter(!showFilter)}
                    >
                      Colonnes
                    </Button>
                  )}
                </div>
              )}
              <div className="flex fr-ml-2w flex-1 justify-end">
                <Button
                  priority={isList ? 'tertiary' : 'secondary'}
                  iconId="fr-icon-layout-bottom-line"
                  onClick={() => setIsList(false)}
                >
                  Tableau
                </Button>
                <Button
                  priority={isList ? 'secondary' : 'tertiary'}
                  iconId="fr-icon-list-unordered"
                  onClick={() => setIsList(true)}
                >
                  Liste
                </Button>
              </div>
            </div>
          </div>
        )}
        <div>
          {isList ? (
            <ExploitationsList exploitations={exploitations} />
          ) : (
            <ExploitationsTable exploitations={exploitations} showFilter={showFilter} />
          )}
        </div>

        {exploitationCount === 0 && (
          <div
            className="border fr-p-4w flex flex-col items-center justify-center flex-1"
            style={{
              color: fr.colors.decisions.text.mention.grey.default,
              borderColor: fr.colors.decisions.border.default.grey.default,
              borderRadius: fr.spacing('1v'),
            }}
          >
            <div>Aucune exploitation enregistrée.</div>
            <Button
              className="fr-mt-3w"
              iconId="fr-icon-add-line"
              linkProps={{ href: '/exploitations/new' }}
            >
              Ajouter une première exploitation
            </Button>
          </div>
        )}

        {exploitationCount > 0 && exploitations.length === 0 && (
          <div
            className="border fr-p-4w flex flex-col items-center justify-center flex-1"
            style={{
              color: fr.colors.decisions.text.mention.grey.default,
              borderColor: fr.colors.decisions.border.default.grey.default,
              borderRadius: fr.spacing('1v'),
            }}
          >
            <div>Aucun résultat trouvé.</div>
          </div>
        )}
      </div>
    </Layout>
  )
}
