import { ChangeEvent, useState } from 'react'
import { Head, router } from '@inertiajs/react'

import { fr } from '@codegouvfr/react-dsfr'
import { Button } from '@codegouvfr/react-dsfr/Button'
import { SearchBar } from '@codegouvfr/react-dsfr/SearchBar'
import { Pagination } from '@codegouvfr/react-dsfr/Pagination'

import Layout from '~/ui/layouts/layout'
import { exportExploitationsAsCSV } from '~/lib/export_csv'
import ExploitationsList from '~/components/exploitations/exploitations-list'
import ExploitationsTable from '~/components/exploitations/exploitations-table'
import { debounce } from 'lodash-es'
import { InferPageProps } from '@adonisjs/inertia/types'
import ExploitationsController from '#controllers/exploitations_controller'
import ButtonWithSelector from '~/ui/ButtonWithSelector'

const handleSearch = debounce((e: ChangeEvent<HTMLInputElement>) => {
  router.reload({
    only: ['exploitationsWithPagination'],
    data: { recherche: e.target.value },
    replace: true,
  })
}, 300)

export default function Exploitations({
  exploitationsWithPagination,
  exploitationCount,
  queryString,
}: InferPageProps<ExploitationsController, 'index'>) {
  const { data: exploitations, meta } = exploitationsWithPagination
  const [isList, setIsList] = useState(queryString?.isList !== 'false')
  const [visibleColumns, setVisibleColumns] = useState<Set<string>>(
    new Set(['organisation', 'utilisateur', 'email', 'telephone', 'localisation'])
  )

  return (
    <Layout>
      <Head title="Exploitations agricoles" />
      <div
        className="fr-p-2w"
        style={{ backgroundColor: fr.colors.decisions.background.alt.blueFrance.default }}
      >
        <div className="fr-container flex justify-between items-center">
          <div>
            <div className="fr-h6 fr-mb-0">Liste des exploitations agricoles</div>
          </div>
          {exploitationCount > 0 && (
            <div className="flex items-center">
              <Button iconId="fr-icon-add-line" linkProps={{ href: '/exploitations/creation' }}>
                Ajouter une exploitation agricole
              </Button>
            </div>
          )}
        </div>
      </div>

      <div className="fr-container fr-mt-4w fr-mb-4w flex flex-col flex-1">
        <div className="w-full flex justify-between fr-mb-4w">
          <SearchBar
            className="flex flex-1 fr-mr-2w"
            renderInput={({ className, id, placeholder, type }) => (
              <input
                className={className}
                id={id}
                placeholder={placeholder}
                type={type}
                onChange={handleSearch}
                defaultValue={queryString?.recherche || ''}
              />
            )}
          />
          <div className="flex items-center flex-1">
            {exploitations.length > 0 && (
              <div className="flex items-center gap-3 flex-1">
                <Button
                  priority="secondary"
                  iconId="fr-icon-download-line"
                  title="Télécharger"
                  onClick={() =>
                    exportExploitationsAsCSV(exploitations, 'exploitations-export.csv')
                  }
                />
                {!isList && (
                  <ButtonWithSelector
                    label="Colonnes"
                    priority="secondary"
                    options={[
                      {
                        value: 'organisation',
                        label: 'Organisation',
                        isSelected: visibleColumns.has('organisation'),
                      },
                      {
                        value: 'utilisateur',
                        label: 'Utilisateur',
                        isSelected: visibleColumns.has('utilisateur'),
                      },
                      { value: 'email', label: 'Email', isSelected: visibleColumns.has('email') },
                      {
                        value: 'telephone',
                        label: 'Téléphone',
                        isSelected: visibleColumns.has('telephone'),
                      },
                      {
                        value: 'localisation',
                        label: 'Localisation',
                        isSelected: visibleColumns.has('localisation'),
                      },
                    ]}
                    onOptionChange={(option) => {
                      setVisibleColumns((prev) => {
                        const newSet = new Set(prev)
                        if (newSet.has(option.value)) {
                          newSet.delete(option.value)
                        } else {
                          newSet.add(option.value)
                        }
                        return newSet
                      })
                    }}
                  />
                )}
              </div>
            )}
            <div className="flex fr-ml-2w flex-1 justify-end">
              <Button
                priority={isList ? 'tertiary' : 'secondary'}
                iconId="fr-icon-layout-bottom-line"
                onClick={() => {
                  setIsList(false)
                  router.visit(
                    `?${new URLSearchParams({ ...queryString, isList: 'false' }).toString()}`,
                    { preserveState: true }
                  )
                }}
              >
                Tableau
              </Button>
              <Button
                priority={isList ? 'secondary' : 'tertiary'}
                iconId="fr-icon-list-unordered"
                onClick={() => {
                  setIsList(true)
                  router.visit(
                    `?${new URLSearchParams({ ...queryString, isList: 'true' }).toString()}`,
                    { preserveState: true }
                  )
                }}
              >
                Liste
              </Button>
            </div>
          </div>
        </div>
        <div>
          {exploitationCount > 0 && exploitations.length === 0 && (
            <div
              className="border fr-p-4w flex flex-col items-center justify-center flex-1"
              style={{
                color: fr.colors.decisions.text.mention.grey.default,
                borderColor: fr.colors.decisions.border.default.grey.default,
                borderRadius: fr.spacing('1v'),
              }}
            >
              <div>Aucun résultat trouvé.</div>
            </div>
          )}
          {isList ? (
            <ExploitationsList exploitations={exploitations} />
          ) : (
            <ExploitationsTable exploitations={exploitations} visibleColumns={visibleColumns} />
          )}
          {exploitationCount > 0 && (
            <div className="fr-mt-4w flex justify-center">
              <Pagination
                count={meta.lastPage}
                defaultPage={meta.currentPage}
                getPageLinkProps={(pageNumber) => {
                  const params = new URLSearchParams()
                  params.set('page', String(pageNumber))
                  if (queryString?.recherche) params.set('recherche', queryString.recherche)
                  if (queryString?.isList === 'false') params.set('isList', 'false')
                  return { href: `?${params.toString()}` }
                }}
              />
            </div>
          )}
        </div>
      </div>
    </Layout>
  )
}
