import { useState } from 'react'
import { Head, usePage, router } from '@inertiajs/react'
import { fr } from '@codegouvfr/react-dsfr'
import { Breadcrumb } from '@codegouvfr/react-dsfr/Breadcrumb'

import Layout from '~/ui/layouts/layout'
import ExploitationForm from '~/components/exploitations/form/exploitation-form'
import ExploitationsController from '#controllers/exploitations_controller'

import { InferPageProps } from '@adonisjs/inertia/types'
import { ExploitationJson } from '../../../types/models'

export default function ExploitationEditionPage({
  exploitation: initialExploitation,
}: InferPageProps<ExploitationsController, 'getForEdition'>) {
  const { url } = usePage()
  const urlParams = new URLSearchParams(url.split('?')[1] || '')
  const step = parseInt(urlParams.get('step') || '1', 10)
  const [exploitation, setExploitation] = useState<ExploitationJson>(initialExploitation)
  const [error, setError] = useState<any>(null)

  const handleSubmit = (exploitationData: ExploitationJson) => {
    router.patch(`/exploitations/${initialExploitation.id}`, exploitationData, {
      onSuccess: () => {
        router.visit(`/exploitations/${initialExploitation.id}`)
      },
      onError: (errors) => {
        setError(errors)
      },
    })
  }

  return (
    <Layout>
      <Head title="Modifier une exploitation" />
      <div
        style={{
          backgroundColor: fr.colors.decisions.background.alt.blueFrance.default,
        }}
      >
        <div className="fr-container">
          <Breadcrumb
            className="fr-my-1w fr-py-1w"
            currentPageLabel="Modifier l'exploitation"
            homeLinkProps={{ href: '/' }}
            segments={[{ label: 'Liste des exploitations', linkProps: { href: '/exploitations' } }]}
          />
        </div>
      </div>
      <ExploitationForm
        step={step}
        setStep={(step) =>
          router.visit(`/exploitations/edition/${initialExploitation.id}?step=${step}`, {
            preserveState: true,
          })
        }
        isEdition={true}
        exploitation={exploitation}
        setExploitation={(newExploitation) => {
          if (newExploitation) setExploitation(newExploitation)
        }}
        error={error}
        onSubmit={handleSubmit}
      />
    </Layout>
  )
}
