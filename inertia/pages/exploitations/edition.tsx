import { Head, usePage, router, useForm } from '@inertiajs/react'
import { fr } from '@codegouvfr/react-dsfr'
import { Breadcrumb } from '@codegouvfr/react-dsfr/Breadcrumb'

import Layout from '~/ui/layouts/layout'
import ExploitationForm, {
  ExploitationFormValues,
  getExploitationFormDefaultValues,
} from '~/components/exploitations/form/exploitation-form'
import ExploitationsController from '#controllers/exploitations_controller'

import { InferPageProps } from '@adonisjs/inertia/types'

export default function ExploitationEditionPage({
  exploitation: initialExploitation,
  exploitationTags,
}: InferPageProps<ExploitationsController, 'getForEdition'>) {
  const { url } = usePage()
  const urlParams = new URLSearchParams(url.split('?')[1] || '')
  const step = parseInt(urlParams.get('step') || '1', 10)
  const { data, setData, errors, setError, patch } = useForm<ExploitationFormValues>(
    getExploitationFormDefaultValues(initialExploitation)
  )

  const handleSubmit = () => {
    patch(`/exploitations/${initialExploitation.id}`, {
      onSuccess: () => {
        router.visit(`/exploitations/${initialExploitation.id}`)
      },
      onError: (errors) => {
        setError(errors)
      },
    })
  }

  return (
    <Layout>
      <Head title="Modifier une exploitation" />
      <div
        style={{
          backgroundColor: fr.colors.decisions.background.alt.blueFrance.default,
        }}
      >
        <div className="fr-container">
          <Breadcrumb
            className="fr-my-1w fr-py-1w"
            currentPageLabel="Modifier l'exploitation agricole"
            homeLinkProps={{ href: '/' }}
            segments={[
              { label: 'Liste des exploitations agricoles', linkProps: { href: '/exploitations' } },
            ]}
          />
        </div>
      </div>
      <ExploitationForm
        step={step}
        visitStep={(step) =>
          router.visit(`/exploitations/edition/${initialExploitation.id}?step=${step}`, {
            preserveState: true,
          })
        }
        isEdition={true}
        initialExploitation={initialExploitation}
        exploitation={data}
        setExploitation={setData}
        error={errors}
        setError={setError}
        onSubmit={handleSubmit}
        exploitationTags={exploitationTags}
      />
    </Layout>
  )
}
