import { useState } from 'react'
import { InferPageProps } from '@adonisjs/inertia/types'
import ExploitationsController from '#controllers/exploitations_controller'
import { Head, router } from '@inertiajs/react'
import Layout from '~/ui/layouts/layout'
import { fr } from '@codegouvfr/react-dsfr'
import { Button } from '@codegouvfr/react-dsfr/Button'
import Breadcrumb from '@codegouvfr/react-dsfr/Breadcrumb'
import { ExploitationInformationCard } from '~/components/exploitation-id/ExploitationInformationCard'
import { ExploitationAddressCard } from '~/components/exploitation-id/ExploitationAddressCard'
import { ExploitationContactCard } from '~/components/exploitation-id/ExploitationContactCard'
import DeleteAlert from '~/ui/DeleteAlert'
import { createModal } from '@codegouvfr/react-dsfr/Modal'
import Alert from '@codegouvfr/react-dsfr/Alert'
import { ExploitationMainColumn } from '~/components/exploitation-id/ExploitationMainColumn'
import Input from '@codegouvfr/react-dsfr/Input'
import TruncatedText from '~/ui/TruncatedText'

const deleteExploitationModal = createModal({
  id: 'delete-exploitation-modal',
  isOpenedByDefault: false,
})

export default function SingleExploitation({
  exploitation,
  deleteExploitationUrl,
  editExploitationUrl,
}: InferPageProps<ExploitationsController, 'get'>) {
  const [isDeleteButtonDisabled, setIsDeleteButtonDisabled] = useState(true)

  return (
    <Layout>
      <Head title={exploitation.name} />
      <div
        className="fr-p-2w"
        style={{ backgroundColor: fr.colors.decisions.background.alt.blueFrance.default }}
      >
        <div className="fr-container flex justify-between items-center">
          <Breadcrumb
            currentPageLabel={
              <TruncatedText maxStringLength={50} hideTooltip>
                {exploitation.name}
              </TruncatedText>
            }
            homeLinkProps={{
              href: '/accueil',
            }}
            segments={[
              {
                label: 'Exploitations agricoles',
                linkProps: {
                  href: '/exploitations',
                },
              },
            ]}
            className={'fr-my-0'}
          />
          <div className="flex items-center">
            <Button
              iconId="fr-icon-edit-line"
              priority={'secondary'}
              linkProps={{ href: `/exploitations/edition/${exploitation.id}` }}
            >
              Éditer l'exploitation
            </Button>
          </div>
        </div>
      </div>
      <div className="fr-container fr-mt-4w fr-mb-4w">
        <section className="grid grid-cols-[350px_1fr] gap-4">
          <aside className="flex flex-col gap-4">
            <ExploitationInformationCard exploitation={exploitation} />
            <ExploitationAddressCard
              exploitation={exploitation}
              editExploitationUrl={editExploitationUrl}
            />
            <ExploitationContactCard
              exploitation={exploitation}
              editExploitationUrl={editExploitationUrl}
            />
            <DeleteAlert
              title="Supprimer l'exploitation"
              description="Attention : cette action est irréversible !"
              size="sm"
              onDelete={deleteExploitationModal.open}
            />
            <deleteExploitationModal.Component
              title=""
              size="large"
              buttons={[
                { children: 'Annuler', doClosesModal: true },
                {
                  children: "Supprimer l'exploitation",
                  disabled: isDeleteButtonDisabled,
                  onClick: () => {
                    router.delete(deleteExploitationUrl)
                  },
                },
              ]}
            >
              <Alert
                severity="error"
                title="Suppression d'une exploitation"
                description="Vous êtes sur le point de supprimer cette exploitation. Cette action est irréversible et entraînera la suppression de toutes les données associées."
              />
              <div className="fr-mt-3w">
                <Input
                  label={`Pour confirmer la suppression, veuillez taper "${exploitation.name}" :`}
                  nativeInputProps={{
                    placeholder: exploitation.name,
                    onChange: (e) => {
                      setIsDeleteButtonDisabled(e.currentTarget.value !== exploitation.name)
                    },
                  }}
                />
              </div>
            </deleteExploitationModal.Component>
          </aside>
          <ExploitationMainColumn
            exploitationId={exploitation.id}
            parcelles={exploitation?.parcelles ?? []}
          />
        </section>
      </div>
    </Layout>
  )
}
