import { useState, useEffect } from 'react'
import { Head, usePage, router } from '@inertiajs/react'
import { fr } from '@codegouvfr/react-dsfr'
import { Breadcrumb } from '@codegouvfr/react-dsfr/Breadcrumb'
import Layout from '~/ui/layouts/layout'
import ExploitationForm from '~/components/exploitations/form/exploitation-form'
import { ExploitationJson } from '../../../types/models'

export default function ExploitationsCreationPage() {
  const { url } = usePage()
  const urlParams = new URLSearchParams(url.split('?')[1] || '')
  const urlStep = parseInt(urlParams.get('step') || '1', 10)
  const [step, setStep] = useState(urlStep)
  const [exploitation, setExploitation] = useState<ExploitationJson | null>(null)

  useEffect(() => {
    router.visit(`/exploitations/creation?step=${step}`, {
      preserveState: true,
      preserveScroll: true,
      replace: true,
    })
  }, [step])

  const handleSubmit = () => {
    if (!exploitation) return

    router.post('/exploitations/creation', exploitation, {
      onSuccess: () => {
        router.visit('/exploitations')
      },
      onError: (errors) => {
        console.error('Erreur lors de la création:', errors)
      },
    })
  }

console.log('exploitation', exploitation)

  return (
    <Layout>
      <Head title="Créer une exploitation" />
      <div
        style={{
          backgroundColor: fr.colors.decisions.background.alt.blueFrance.default,
        }}
      >
        <div className="fr-container">
          <Breadcrumb
            className="fr-my-1w fr-py-1w"
            currentPageLabel="Nouvelle exploitation"
            homeLinkProps={{ href: '/' }}
            segments={[{ label: 'Liste des exploitations', linkProps: { href: '/exploitations' } }]}
          />
        </div>
      </div>
      <ExploitationForm
        step={step}
        setStep={setStep}
        exploitation={exploitation}
        setExploitation={setExploitation}
        onSubmit={handleSubmit}
      />
    </Layout>
  )
}
