import { useState } from 'react'
import { Head, usePage, router } from '@inertiajs/react'
import { fr } from '@codegouvfr/react-dsfr'
import { Breadcrumb } from '@codegouvfr/react-dsfr/Breadcrumb'

import Layout from '~/ui/layouts/layout'
import ExploitationForm from '~/components/exploitations/form/exploitation-form'

import { ExploitationJson } from '../../../types/models'

export default function ExploitationsCreationPage() {
  const { url } = usePage()
  const urlParams = new URLSearchParams(url.split('?')[1] || '')
  const step = parseInt(urlParams.get('step') || '1', 10)
  const [exploitation, setExploitation] = useState<ExploitationJson | null>(null)
  const [error, setError] = useState<any>(null)

  const handleSubmit = (exploitationData: ExploitationJson) => {
    router.post('/exploitations/creation', exploitationData, {
      onSuccess: () => {
        router.visit('/exploitations')
      },
      onError: (errors) => {
        setError(errors)
      },
    })
  }

  return (
    <Layout>
      <Head title="CrÃ©er une exploitation" />
      <div
        style={{
          backgroundColor: fr.colors.decisions.background.alt.blueFrance.default,
        }}
      >
        <div className="fr-container">
          <Breadcrumb
            className="fr-my-1w fr-py-1w"
            currentPageLabel="Nouvelle exploitation"
            homeLinkProps={{ href: '/' }}
            segments={[{ label: 'Liste des exploitations', linkProps: { href: '/exploitations' } }]}
          />
        </div>
      </div>
      <ExploitationForm
        step={step}
        setStep={(step) =>
          router.visit(`/exploitations/creation?step=${step}`, { preserveState: true })
        }
        exploitation={exploitation}
        setExploitation={setExploitation}
        error={error}
        onSubmit={handleSubmit}
      />
    </Layout>
  )
}
