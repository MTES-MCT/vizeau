import { Head, usePage, router, useForm } from '@inertiajs/react'
import { fr } from '@codegouvfr/react-dsfr'
import { Breadcrumb } from '@codegouvfr/react-dsfr/Breadcrumb'

import Layout from '~/ui/layouts/layout'
import ExploitationForm, {
  ExploitationFormValues,
  getExploitationFormDefaultValues,
} from '~/components/exploitations/form/exploitation-form'

import { InferPageProps } from '@adonisjs/inertia/types'
import ExploitationsController from '#controllers/exploitations_controller'

export default function ExploitationsCreationPage({
  exploitationTags,
}: InferPageProps<ExploitationsController, 'create'>) {
  const { url } = usePage()
  const urlParams = new URLSearchParams(url.split('?')[1] || '')
  const step = parseInt(urlParams.get('step') || '1', 10)
  const { data, setData, errors, setError, post } = useForm<ExploitationFormValues>(
    getExploitationFormDefaultValues()
  )

  const handleSubmit = () => {
    post('/exploitations/creation', {
      onSuccess: () => {
        router.visit('/exploitations')
      },
      onError: (errors) => {
        setError(errors)
      },
    })
  }

  return (
    <Layout>
      <Head title="CrÃ©er une exploitation" />
      <div
        style={{
          backgroundColor: fr.colors.decisions.background.alt.blueFrance.default,
        }}
      >
        <div className="fr-container">
          <Breadcrumb
            className="fr-my-1w fr-py-1w"
            currentPageLabel="Nouvelle exploitation agricole"
            homeLinkProps={{ href: '/' }}
            segments={[
              { label: 'Liste des exploitations agricoles', linkProps: { href: '/exploitations' } },
            ]}
          />
        </div>
      </div>
      <ExploitationForm
        step={step}
        visitStep={(step) =>
          router.visit(`/exploitations/creation?step=${step}`, { preserveState: true })
        }
        exploitation={data}
        setExploitation={setData}
        error={errors}
        setError={setError}
        onSubmit={handleSubmit}
        exploitationTags={exploitationTags}
      />
    </Layout>
  )
}
